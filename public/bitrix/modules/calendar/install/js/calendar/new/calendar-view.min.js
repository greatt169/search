(function(e){function t(e){this.calendar=e;this.util=e.util;this.entryController=e.entryController;this.name="#calendar view#";this.title=this.name;this.enabled=true;this.contClassName="";this.isBuilt=false;this.animateClass="calendar-grid-animate";this.collapseOffHours=this.util.getUserOption("collapseOffHours","Y")=="Y";this.entries=[];this.entriesIndex={};BX.addCustomEvent(this.calendar,"viewOnClick",BX.proxy(this.handleClick,this))}t.prototype={build:function(){this.viewCont=BX.create("DIV",{props:{className:this.contClassName}})},show:function(){if(!this.isBuilt){this.build();this.isBuilt=true}this.viewCont.style.display="";this.setTitle()},refresh:function(){this.displayEntries()},hide:function(){this.viewCont.style.display="none"},getName:function(){return this.name},getContainer:function(){return this.viewCont},setTitle:function(e){this.calendar.viewTitle.innerHTML=e.replace("#GRAY_START#",'<span class="calendar-top-title-gray">').replace("#GRAY_END#","</span>")},getIsBuilt:function(){return this.isBuilt},fadeAnimation:function(e,t,i){new BX.easing({duration:t||200,start:{opacity:100},finish:{opacity:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(t){e.style.opacity=t.opacity/100},complete:function(){if(i&&BX.type.isFunction(i))i()}}).animate()},showAnimation:function(e,t,i){new BX.easing({duration:t||200,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(t){e.style.opacity=t.opacity/100},complete:function(){e.removeAttribute("style");if(i&&BX.type.isFunction(i))i()}}).animate()},getArrow:function(e,t,i){var s=BX.util.urlencode(t),a=i?BX.util.urlencode(t):"none",r="",n;if(e=="left"){n=BX.create("DIV",{props:{className:"calendar-event-angle-start-yesterday"}});r="url(data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2215px%22%20height%3D%2218px%22%20viewBox%3D%220%200%2015%2018%22%20version%3D%221.1%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%0A%3Cpath%20fill%3D%22"+a+"%22%20stroke%3D%22"+s+"%22%20stroke-width%3D%221%22%20d%3D%22M14.5%2C17.5%20L14.5%2C0.5%20L2.00049088%2C0.5%20C1.78697323%2C0.5%201.57591593%2C0.545584%201.38143042%2C0.633704227%20C0.626846099%2C0.975601882%200.292297457%2C1.86447615%200.634195112%2C2.61906047%20L3.05787308%2C7.96823256%20C3.35499359%2C8.62399158%203.35499359%2C9.37600842%203.05787308%2C10.0317674%20L0.634195112%2C15.3809395%20C0.546074885%2C15.575425%200.500490885%2C15.7864823%200.500490885%2C16%20C0.500490885%2C16.8284271%201.17206376%2C17.5%202.00049088%2C17.5%20L14.5%2C17.5%20Z%22/%3E%0A%3C/svg%3E)"}else{n=BX.create("DIV",{props:{className:"calendar-event-angle-finish-tomorrow"}});r="url(data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2215px%22%20height%3D%2218px%22%20viewBox%3D%220%200%2015%2018%22%20version%3D%221.1%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%0A%3Cpath%20fill%3D%22"+a+"%22%20stroke%3D%22"+s+"%22%20stroke-width%3D%221%22%20d%3D%22M0.5%2C0.5%20L0.5%2C17.5%20L8.7031205%2C17.5%20C9.65559352%2C17.5%2010.5253145%2C16.9587787%2010.9460243%2C16.1042565%20L13.8991717%2C10.1059895%20C14.2418971%2C9.40986472%2014.2419701%2C8.59406382%2013.8993692%2C7.89787777%20L10.9458495%2C1.89614482%20C10.5252214%2C1.04140271%209.65538246%2C0.5%208.70274816%2C0.5%20L0.5%2C0.5%20Z%22/%3E%0A%3C/svg%3E)"}n.style.backgroundImage=r;return n},occupySlot:function(e){if(this.days){var t;for(t=e.startIndex;t<e.endIndex;t++){if(this.days[t]){this.days[t].slots[e.slotIndex]=false}}}},showSimplePopup:function(t){if(this.calendar.isExternalMode()){this.calendar.triggerEvent("createNewEntry",t);setTimeout(BX.delegate(function(){if(t.closeCallback&&typeof t.closeCallback=="function"){t.closeCallback()}},this),300);return}if(!this.simpleEntryPopup){this.simpleEntryPopup=new e.BXEventCalendar.SimpleAddPopup(this.calendar)}this.simpleEntryPopup.show(t)},showSimpleViewPopup:function(t){if(!this.simpleViewPopup){this.simpleViewPopup=new e.BXEventCalendar.SimpleViewPopup(this.calendar)}else if(this.simpleViewPopup.isShown()){this.simpleViewPopup.close()}this.simpleViewPopup.show(t)},showEditSlider:function(t){if(this.simpleViewPopup){this.simpleViewPopup.close()}if(!t||!t.entry){t={}}if(this.simpleEntryPopup){t.newEntryData=this.simpleEntryPopup.getPopupData();this.simpleEntryPopup.close()}if(!this.calendar.editSlider){this.calendar.editSlider=new e.BXEventCalendar.EditEntrySlider(this.calendar)}this.calendar.editSlider.show(t)},handleEntryClick:function(e){e.entry=e.entry||this.getEntryById(e.uid);if(this.calendar.isExternalMode()){return this.calendar.triggerEvent("entryClick",e)}if(e.entry.isSelected()){if(e.entry.isTask()){BX.SidePanel.Instance.open(this.calendar.util.getViewTaskPath(e.entry.id),{loader:"task-new-loader"})}else{this.showViewSlider({entry:e.entry})}}this.selectEntry(e.entry);if(this.name=="week"||this.name=="month"){this.showSimpleViewPopup(e)}},showViewSlider:function(t){if(!this.calendar.util.useViewSlider()){return}if(!this.calendar.viewSlider){this.calendar.viewSlider=new e.BXEventCalendar.ViewEntrySlider(this.calendar)}this.calendar.viewSlider.show(t);if(this.simpleViewPopup){this.simpleViewPopup.close()}setTimeout(BX.delegate(function(){if(this.simpleViewPopup){this.simpleViewPopup.close()}},this),200)},isActive:function(){return this.calendar.currentViewName===this.name},getEntryById:function(e){if(e&&this.entriesIndex[e]!==undefined&&this.entries[this.entriesIndex[e]])return this.entries[this.entriesIndex[e]];return false},selectEntry:function(e){if(e&&e.parts){if(this.selectedEntry)this.deselectEntry();if(e.select)e.select();e.parts.forEach(function(t){t.params=this.selectEntryPart(t.params,e.color,e.isExpired())},this);this.selectedEntry=e;if(this.name!=="week"&&this.name!=="month"){this.showAdditionalInfo(e)}}},selectEntryPart:function(e,t){if(e.wrapNode){e.backupWrapZIndex=e.wrapNode.style.zIndex||"";e.wrapNode.style.zIndex=4e3;e.backupWrapNodeClass=e.wrapNode.className;BX.addClass(e.wrapNode,"calendar-event-line-fill");BX.addClass(e.wrapNode,"active")}if(e.blockBackgroundNode){e.backupBlockOpacity=e.blockBackgroundNode.style.opacity;e.blockBackgroundNode.style.opacity=1}if(e.innerContainer){e.backupBackground=e.innerContainer.style.background;e.backupBorderColor=e.innerContainer.style.borderColor;e.innerContainer.style.backgroundColor=t;e.innerContainer.style.borderColor=t}if(e.nameNode){e.backupNameColor=e.nameNode.style.color;e.nameNode.style.color="#fff"}if(e.timeNode){e.backupTimeColor=e.timeNode.style.color;e.backupTimeZIndex=e.timeNode.style.zIndex||0;e.timeNode.style.color="#fff";e.timeNode.style.zIndex=200}return e},deselectEntry:function(e){if(!e&&this.selectedEntry)e=this.selectedEntry;if(e){if(e.deselect)e.deselect();e.parts.forEach(function(e){if(e.params.wrapNode){e.params.wrapNode.className=e.params.backupWrapNodeClass;e.params.wrapNode.style.zIndex=e.params.backupWrapZIndex}if(e.params.innerContainer){e.params.innerContainer.style.backgroundColor=e.params.backupBackground;e.params.innerContainer.style.borderColor=e.params.backupBorderColor}if(e.params.blockBackgroundNode){e.params.blockBackgroundNode.style.opacity=e.params.backupBlockOpacity}if(e.params.nameNode){e.params.nameNode.style.color=e.params.backupNameColor}if(e.params.timeNode){e.params.timeNode.style.color=e.params.backupTimeColor;e.params.timeNode.style.zIndex=e.params.backupTimeZIndex}},this)}BX.remove(this.calendar.additionalInfoOuter);this.selectedEntry=false},getSelectedEntry:function(){return this.selectedEntry||false},preloadEntries:function(){},showAllEventsInPopup:function(e){var t,i;t=BX.create("DIV",{props:{className:"calendar-all-events-popup calendar-custom-scroll"},events:{click:BX.proxy(this.calendar.handleViewsClick,this.calendar)}});e.day.entries.list.sort(this.calendar.entryController.sort);var s,a;e.day.entries.list.forEach(function(e){if(e.entry){if(e.entry.isTask()){if(!s){t.appendChild(BX.create("DIV",{props:{className:"calendar-event-title"},text:BX.message("EC_ENTRIES_TASKS")}));s=t.appendChild(BX.create("DIV",{props:{className:"calendar-event-block"}}))}this.displayEntryPiece({entry:e.entry,part:e.part,holder:s,popupMode:true})}else{if(!a){t.appendChild(BX.create("DIV",{props:{className:"calendar-event-title"},text:BX.message("EC_ENTRIES_EVENTS")}));a=t.appendChild(BX.create("DIV",{props:{className:"calendar-event-block"}}))}this.displayEntryPiece({entry:e.entry,part:e.part,holder:a,popupMode:true})}}},this);i=BX.PopupWindowManager.create(this.calendar.id+"-all-events-popup",e.day.hiddenStorage,{autoHide:true,closeByEsc:true,offsetTop:-2,offsetLeft:this.getDayWidth()/2+4,lightShadow:true,content:t});i.setAngle({offset:118});i.show(true);this.allEventsPopup=i;BX.addCustomEvent(i,"onPopupClose",function(){i.destroy()})},showAdditionalInfo:function(t){BX.remove(this.calendar.additionalInfoOuter);this.calendar.additionalInfoOuter=this.calendar.rightBlock.appendChild(BX.create("DIV",{props:{className:"calendar-right-block hide"}}));if(!this.simpleViewPopup)this.simpleViewPopup=new e.BXEventCalendar.SimpleViewPopup(this.calendar);this.calendar.additionalInfoOuter.appendChild(this.simpleViewPopup.createContent({entry:t}))},showNavigationCalendar:function(){setTimeout(BX.delegate(function(){if(this.calendar.rightBlock){if(!this.calendar.navCalendar){this.calendar.navCalendar=new e.BXEventCalendar.NavigationCalendar(this.calendar,{wrap:this.calendar.rightBlock.appendChild(BX.create("DIV",{props:{className:"calendar-right-block"}}))})}if(this.calendar.initialViewShow){BX.addClass(this.calendar.mainCont,"calendar-main-container-small-calendar");this.calendar.initialViewShow=false}this.calendar.navCalendar.show()}},this),0)},getDayWidth:function(){var e=200;if(this.days&&this.days[0]&&this.days[0].node){e=this.days[0].node.offsetWidth||e}return Math.min(e,400)}};function i(){t.apply(this,arguments);this.initConfig();this.preBuild()}i.prototype=Object.create(t.prototype);i.prototype.constructor=i;i.prototype.initConfig=function(){this.name="day";this.gridLineHeight=60;this.slotHeight=20;this.title=BX.message("EC_VIEW_DAY");this.entryWidthOffset=2;this.lastEntryWidthOffset=14;this.contClassName="calendar-day-view";this.gridWrapClass="calendar-grid-wrap";this.fullDayContClass="calendar-grid-day-full-days-events-holder";this.fullDayContHolderClass="calendar-grid-week-full-days-events-holder-grid";this.topEntryHolderClass="calendar-grid-day-events-holder";this.outerGridClass="calendar-grid-day-container";this.gridClass="calendar-grid-day";this.gridClassCurrent="calendar-grid-day-current";this.gridClassNext="calendar-grid-day-left-slide";this.gridClassPrevious="calendar-grid-day-right-slide";this.changeNextClass="calendar-change-day-left-slide";this.changePreviousClass="calendar-change-day-right-slide";this.gridRowClass="calendar-grid-day-row";this.gridCellClass="calendar-grid-day-cell";this.gridTimelinesClass="calendar-grid-day-time-lines";this.gridTimelineHourClass="calendar-grid-day-time-line-hour";this.gridTimelineHourLabelClass="calendar-grid-day-time-line-hour-label";this.gridTimelineHourLabelClassInner="calendar-grid-week-time-line-hour-label-inner";this.gridNowTimeClass="calendar-grid-day-time-line-hour-now";this.gridNowTimeLabelClass="calendar-grid-day-time-line-hour-label";this.gridNowTimeLineClass="calendar-grid-day-time-line-hour-now-line";this.gridNowTimeDotClass="calendar-grid-day-time-line-hour-now-dot";this.gridTimeTranslucentClass="calendar-grid-time-line-translucent";this.offHoursClass="calendar-grid-off-hours";this.offHoursCollapseClass="calendar-grid-off-hours-collapse";this.offHoursAnimateClass="calendar-grid-off-hours-animate";this.offHoursFastAnimateClass="calendar-grid-off-hours-fast-animate";this.dayCount=1};i.prototype.preBuild=function(){this.viewCont=BX.create("DIV",{props:{className:this.contClassName},style:{display:"none"}})};i.prototype.build=function(){this.titleCont=this.viewCont.appendChild(BX.create("DIV",{props:{className:"calendar-grid-week-row-days-week"}}));var e=this.util.getWorkTime();this.checkTimelineScroll(!this.collapseOffHours||(e.end-e.start)*this.gridLineHeight+20>this.util.getViewHeight());this.fullDayEventsCont=this.viewCont.appendChild(BX.create("DIV",{props:{className:this.fullDayContClass}}));this.gridWrap=this.viewCont.appendChild(BX.create("DIV",{props:{className:this.gridWrapClass},style:{height:this.util.getViewHeight()+"px"}}));this.outerGrid=this.gridWrap.appendChild(BX.create("DIV",{props:{className:this.outerGridClass}}));this.grid=this.outerGrid.appendChild(BX.create("DIV",{props:{className:this.gridClass+" "+this.gridClassCurrent}}));BX.bind(this.gridWrap,"mousedown",BX.proxy(this.handleMousedown,this))};i.prototype.show=function(){t.prototype.show.apply(this,arguments);this.buildDaysGrid();this.showNavigationCalendar();BX.remove(this.calendar.additionalInfoOuter);this.displayEntries()};i.prototype.hide=function(){t.prototype.hide.apply(this,arguments)};i.prototype.setFullDayHolderSize=function(e){this.fullDayEventsCont.style.height=e*(this.slotHeight+1)+"px"};i.prototype.increaseViewRangeDate=function(){this.changeViewRangeDate(this.dayCount);this.setTitle();if(this.gridWrap)this.gridWrap.style.overflowX="hidden";var e=this.outerGrid.appendChild(BX.create("DIV",{props:{className:this.gridClass+" "+this.gridClassNext+" "+this.animateClass}}));BX.addClass(this.grid,this.animateClass);this.buildDaysGrid({grid:e});this.preloadEntries();setTimeout(BX.delegate(function(){BX.addClass(this.outerGrid,this.changeNextClass);setTimeout(BX.delegate(function(){BX.removeClass(this.outerGrid,this.changeNextClass);BX.removeClass(e,this.gridClassNext);BX.addClass(e,this.gridClassCurrent);BX.remove(this.grid);this.grid=e;BX.removeClass(this.grid,this.animateClass);this.gridWrap.style.overflowX="";this.displayEntries()},this),400)},this),0)};i.prototype.decreaseViewRangeDate=function(){this.changeViewRangeDate(-this.dayCount);this.setTitle();this.gridWrap.style.overflowX="hidden";var e=this.outerGrid.appendChild(BX.create("DIV",{props:{className:this.gridClass+" "+this.gridClassPrevious+" "+this.animateClass}}));BX.addClass(this.grid,this.animateClass);this.buildDaysGrid({grid:e});setTimeout(BX.delegate(function(){BX.addClass(this.outerGrid,this.changePreviousClass);setTimeout(BX.delegate(function(){BX.removeClass(this.outerGrid,this.changePreviousClass);BX.removeClass(e,this.gridClassPrevious);BX.addClass(e,this.gridClassCurrent);BX.remove(this.grid);this.grid=e;BX.removeClass(this.grid,this.animateClass);this.gridWrap.style.overflowX="";this.displayEntries()},this),400)},this),0)};i.prototype.changeViewRangeDate=function(e){var t=this.calendar.getViewRangeDate(),i=new Date(t.getTime());i.setDate(i.getDate()+e);this.calendar.setViewRangeDate(i);return i};i.prototype.getViewRange=function(){var e=this.calendar.getViewRangeDate(),t=new Date(e.getTime());t.setDate(t.getDate()+this.dayCount);return{start:e,end:t}};i.prototype.getAdjustedDate=function(e,t){if(!e){e=new Date}if(t&&e.getTime()<t.start.getTime()){e=new Date(t.start.getTime())}if(t&&e.getTime()>t.end.getTime()){e=new Date(t.end.getTime())}var i=false;if(e&&e.getTime){e.setHours(0,0,0,0);i=new Date(e.getTime())}return i};i.prototype.adjustViewRangeToDate=function(e,t){var i=this.calendar.getViewRangeDate(),s=false;if(e&&e.getTime){e.setHours(0,0,0,0);var a=(e.getTime()-i.getTime())/this.calendar.util.dayLength;if(a==this.dayCount){this.increaseViewRangeDate()}else if(a==-this.dayCount){this.decreaseViewRangeDate()}else{s=new Date(e.getTime());s.setHours(0,0,0,0);this.calendar.setViewRangeDate(s);if(t===false){this.show()}else{this.fadeAnimation(this.getContainer(),100,BX.delegate(function(){this.show();this.getContainer().style.opacity=0;this.showAnimation(this.getContainer(),300)},this))}}}return s};i.prototype.buildDaysGrid=function(e){if(!e)e={};var t,i,s=e.grid||this.grid,a=this.calendar.getViewRangeDate(),r=new Date(a.getTime());if(this.dayCount>1){r=this.getAdjustedDate(r)}BX.cleanNode(s);BX.cleanNode(this.fullDayEventsCont);this.holderTitle=this.fullDayEventsCont.appendChild(BX.create("DIV",{props:{className:"calendar-grid-day-full-days-events-holder-title"},text:BX.message("EC_VIEW_DAY")}));this.fullDayEventsHolderCont=this.fullDayEventsCont.appendChild(BX.create("DIV",{props:{className:this.fullDayContHolderClass}}));this.topEntryHolder=this.fullDayEventsCont.appendChild(BX.create("DIV",{props:{className:this.topEntryHolderClass}}));this.gridRow=s.appendChild(BX.create("DIV",{props:{className:this.gridRowClass+" "+this.animateClass},style:{height:this.getDayGridHeight()+"px"}}));this.dayIndex={};this.days=[];if(this.titleCont){BX.cleanNode(this.titleCont)}this.gridRowShadow=BX.create("DIV",{props:{className:"calendar-grid-week-row-shadow"}});for(t=0;t<this.dayCount;t++){i=this.util.getDayCode(r);this.fullDayEventsHolderCont.appendChild(BX.create("DIV",{attrs:{"data-bx-calendar-week-day":i},props:{className:this.gridCellClass}}));this.buildDayCell({date:r,month:"previous",grid:s});if(this.dayCount>1)r.setDate(r.getDate()+1);this.gridRowShadow.appendChild(BX.create("DIV",{attrs:{"data-bx-calendar-timeline-day":i},props:{className:"calendar-grid-week-cell"},html:'<span class="calendar-grid-cell-inner"></span>'}))}this.timeLinesCont=this.gridRow.appendChild(BX.create("DIV",{props:{className:this.gridTimelinesClass}}));this.timelineEntryHolder=this.gridRow.appendChild(BX.create("DIV",{props:{className:this.topEntryHolderClass}}));this.timeLinesIndex=[];for(t=0;t<=24;t++){this.timeLinesIndex[t]=this.timeLinesCont.appendChild(BX.create("DIV",{props:{className:this.gridTimelineHourClass},html:'<div class="'+this.gridTimelineHourLabelClass+'">'+this.calendar.util.formatTime(t,0,true)+"</div>",style:{top:t*this.gridLineHeight+"px"}}))}this.gridRow.appendChild(this.gridRowShadow);setTimeout(BX.delegate(function(){if(!this.gridWrap.scrollTop&&!this.collapseOffHours){var e=this.util.getWorkTime();this.gridWrap.scrollTop=e.start*this.gridLineHeight-5}},this),0);this.showOffHours();this.showNowTime(this.timeLinesCont);this.gridRow.appendChild(BX.create("DIV",{props:{className:"calendar-grid-day-events-holder"}}))};i.prototype.buildDayCell=function(e){var t=e.date,i="",s="",a=Math.round(t.getTime()/1e3)*1e3,r=t.getDay(),n=this.util.getDayCode(t),o=this.util.getWeekDayByInd(r);if(e.month=="previous"){s+=" calendar-grid-previous-month-day"}else if(e.month=="next"){s+=" calendar-grid-next-month-day"}if(this.util.isHoliday(t)){s+=" calendar-grid-holiday"}if(this.util.isToday(t)){i+=" calendar-grid-today"}if(this.titleCont&&this.name=="week"){this.titleCont.appendChild(BX.create("DIV",{props:{className:this.gridCellClass+i},html:'<span class="calendar-grid-cell-inner" data-bx-calendar-date="'+a+'">'+BX.message("EC_WEEK_TITLE").replace("#DAY_OF_WEEK#",BX.date.format("D",a/1e3)).replace("#DATE#",t.getDate())+"</span>"}))}else if(this.titleCont){this.titleCont.appendChild(BX.create("DIV",{props:{className:this.gridCellClass+i},html:'<span class="calendar-grid-cell-inner" data-bx-calendar-date="'+a+'">'+'<span class="calendar-day-of-week-day">'+BX.date.format("l",a/1e3)+"</span>"+"</span>"}))}this.days.push({date:new Date(t.getTime()),dayOffset:this.util.getWeekDayOffset(o),node:this.gridRow.appendChild(BX.create("DIV",{attrs:{"data-bx-calendar-timeline-day":n},props:{className:this.gridCellClass+s+" a1"},html:'<span class="calendar-grid-cell-inner"></span>'})),dayCode:n});this.dayIndex[this.days[this.days.length-1].dayCode]=this.days.length-1;this.calendar.dragDrop.registerTimelineDay(this.days[this.days.length-1])};i.prototype.setTitle=function(){var e=this.calendar.getViewRangeDate(),i=e.getTime()/1e3;t.prototype.setTitle.apply(this,[BX.date.format(BX.message("EC_DATE_FORMAT_1_MAY"),i)+" #GRAY_START#"+BX.date.format("Y",i)+"#GRAY_END#"])};i.prototype.displayEntries=function(e){var t,i,s,a,r,n,o=0,l=this.getViewRange();if(!e)e={};if(e.reloadEntries!==false){this.entries=this.entryController.getList({startDate:new Date(l.start.getFullYear(),l.start.getMonth(),1),finishDate:new Date(l.end.getFullYear(),l.end.getMonth()+1,1),viewRange:l,finishCallback:BX.proxy(this.displayEntries,this)})}this.partsStorage=[];this.timelinePartsStorage=[];BX.cleanNode(this.topEntryHolder);BX.cleanNode(this.timelineEntryHolder);this.fullDayEventsCont.style.height="";this.days.forEach(function(e){e.slots=[];e.timelineMap={};e.entries={topList:[],started:[],timeline:[],hidden:[]}});if(this.entries&&this.entries.length){for(t=0;t<this.entries.length;t++){i=this.entries[t];this.entriesIndex[i.uid]=t;i.cleanParts();n=false;for(a=this.dayIndex[i.startDayCode];a<this.days.length;a++){r=this.days[a];if(!i.isLongWithTime()&&r.dayCode==i.startDayCode&&r.dayCode==i.endDayCode&&!i.fullDay){s=i.startPart({from:r,to:r,daysCount:0,fromTimeValue:this.util.getTimeValue(i.from),toTimeValue:this.util.getTimeValue(i.to)});r.entries.timeline.push({entry:i,part:s});this.timelinePartsStorage.push({part:s,entry:i});break}else{if(r.dayCode==i.startDayCode){n=true;s=i.startPart({from:r,daysCount:0});r.entries.started.push({entry:i,part:s})}if(n){r.entries.topList.push({entry:i,part:s});s.daysCount++;s.to=r;if(r.entries.topList.length>o)o=r.entries.topList.length;if(r.dayCode==i.endDayCode||r.dayOffset==this.dayCount-1||this.dayCount==1){this.partsStorage.push({part:s,entry:i});if(r.dayCode==i.endDayCode){break}}}}}}}this.setFullDayHolderSize(Math.max(o,1));if(this.entries&&this.entries.length){this.displayTopEntries();this.displayTimelineEntries();this.slotsCount=100;this.arrangeTopEntries();this.arrangeTimelineEntries()}BX.addClass(this.grid,"calendar-events-holder-show");BX.addClass(this.fullDayEventsCont,"calendar-events-holder-show");var d=this.util.getWorkTime();this.checkTimelineScroll(!this.collapseOffHours||(d.end-d.start)*this.gridLineHeight+20>this.util.getViewHeight())};i.prototype.arrangeTopEntries=function(){var e,t,i,s,a,r,n;for(i=0;i<this.days.length;i++){s=this.days[i];if(s.entries.started.length>0){s.entries.started.sort(this.calendar.entryController.sort);for(e=0;e<s.entries.started.length;e++){if(s.entries.started[e]){a=s.entries.started[e].entry;r=s.entries.started[e].part;if(!a.checkPartIsRegistered(r))continue;n=false;for(t=0;t<this.slotsCount;t++){if(s.slots[t]!==false){this.occupySlot({slotIndex:t,startIndex:i,endIndex:i+r.daysCount});n=true;a.getWrap(r.partIndex).style.top=t*this.slotHeight+"px";break}}}if(s.hiddenStorage&&s.entries.hidden.length>0){s.hiddenStorageText.innerHTML=BX.message("EC_SHOW_ALL")+" ("+s.entries.list.length+")"}}}}};i.prototype.arrangeTimelineEntries=function(){var e=30,t=33,i=20,s=40,a=23,r=6,n=2,o,l,d,h,p,c,f,u,m,y,g,C,w,T,B,v,x,D,X;function E(e){var t,i;for(t=e.timeFrom;t<e.timeTo;t++){if(!e.layers[t])e.layers[t]=[];i=e.day.layers[t][e.layerIndex]||{entries:[],start:[]};i.entries.push(e.entryIndex);if(t==e.timeFrom){i.start.push(e.entryIndex);e.entryPart.layerParallels=i.start.length}e.day.layers[t][e.layerIndex]=i}e.entryPart.layerIndex=e.layerIndex}function N(e,t){var i=f.layers[e][t];return i&&i.entries&&i.entries.length==i.start.length}function I(e){return!e}function b(e){var t,i,s,a=[],r={};for(t=e.timeFrom;t<e.timeTo;t++){if(e.layerIndex>0&&e.day.layers[t][e.layerIndex-1]){i=e.day.layers[t][e.layerIndex-1].entries;if(i.length>0){s=i[i.length-1];if(!r[s]){r[s]=true;a.push(s)}}}}return a}function H(t,i){if(!i)i=e;return t.getHours()*60+Math.floor(t.getMinutes()/i)*i}for(c=0;c<this.days.length;c++){f=this.days[c];f.entries.timeline.sort(function(e,t){if(e.part.fromTimeValue==t.part.fromTimeValue)return t.part.toTimeValue-t.part.fromTimeValue-(e.part.toTimeValue-e.part.fromTimeValue);return e.part.fromTimeValue-t.part.fromTimeValue});o=0;d="";l=0;C=0;f.layers=[];for(h=0;h<f.entries.timeline.length;h++){D=f.entries.timeline[h].entry;X=f.entries.timeline[h].part;y=H(D.from);g=H(D.to,1);if(y==g)g+=1;if(!f.layers)f.layers=[];w=0;while(true){if(!f.layers[y]||N(y,w)||I(f.layers[y][w])){E({day:f,timeFrom:y,timeTo:g,layers:f.layers,entryIndex:h,layerIndex:w,entryPart:X});break}w++}}for(h=0;h<f.entries.timeline.length;h++){if(f.entries.timeline[h]){D=f.entries.timeline[h].entry;X=f.entries.timeline[h].part;y=H(D.from);g=H(D.to,1);if(y==g)g+=1;if(!D.checkPartIsRegistered(X)||!f.layers[y]||!f.layers[y][X.layerIndex]){continue}m=f.layers[y][X.layerIndex].start;if(X.params&&X.params.wrapNode){X.params.wrapNode.style.zIndex=y}X.absoluteLeftOffset=n;if(X.layerIndex>0){x=b({day:f,entryIndex:h,layerIndex:X.layerIndex,timeFrom:y,timeTo:g});for(p=0;p<x.length;p++){T=f.entries.timeline[x[p]];if(T&&T.part&&T.part.params&&X.params.wrapNode){B=parseInt(X.params.wrapNode.style.top)-parseInt(T.part.params.wrapNode.style.top);if(B>t){X.offsetFractionLeft=T.part.offsetFractionWidth*.1}else{X.offsetFractionLeft=T.part.offsetFractionWidth*.45}X.offsetFractionLeftTotal=T.part.offsetFractionLeftTotal+X.offsetFractionLeft;X.offsetFractionWidth=1-X.offsetFractionLeftTotal;if(this.dayCount>1){X.offsetLeftRate=X.from.dayOffset+X.offsetFractionLeftTotal}else{X.offsetLeftRate=X.offsetFractionLeftTotal}X.absoluteLeftOffset=(T.absoluteLeftOffset||n)+r;v=1-X.offsetFractionLeftTotal;if(B<=t){if(B<i){T.part.params.timeNode.style.maxWidth="calc("+(1-X.offsetFractionWidth)*100+"% - 4px)";if(T.part.params.timeNode.offsetWidth<s){T.part.params.timeNode.style.textOverflow="clip";T.part.params.timeNode.style.maxWidth=s+"px"}}T.part.params.nameNode.style.maxWidth="calc("+(1-X.offsetFractionWidth)*100+"% - 4px)";if(T.part.params.nameNode.offsetWidth<s){T.part.params.nameNode.style.textOverflow="clip";T.part.params.nameNode.style.maxWidth="calc("+(1-X.offsetFractionWidth)*100+"% + 5px)";this.checkTimelineEntrySize(T.part,T.entry,true)}}else{T.part.params.nameNode.style.maxHeight=B-a+"px"}X.params.wrapNode.style.left="calc((100% / "+this.dayCount+") * "+X.offsetLeftRate+")";X.params.wrapNode.style.width="calc(100% / ("+this.dayCount+") * "+X.offsetFractionWidth+" - "+this.lastEntryWidthOffset+"px)";BX.addClass(X.params.wrapNode,"calendar-bordered-block")}}}if(m.length>1){u=BX.util.array_search(h,f.layers[y][X.layerIndex].start);var k=this.entryWidthOffset;if(u==f.layers[y][X.layerIndex].start.length-1){k=this.lastEntryWidthOffset;if(X.absoluteLeftOffset>n){k+=X.absoluteLeftOffset/m.length+1}}if(this.dayCount>1){X.params.wrapNode.style.width="calc(100% / ("+this.dayCount+" * "+m.length+") - "+k+"px)";X.params.wrapNode.style.left="calc((100% / "+this.dayCount+") * "+X.from.dayOffset+" + 100% * "+u+"/ ("+this.dayCount+" * "+m.length+") + "+X.absoluteLeftOffset+"px)"}else{X.params.wrapNode.style.width="calc(100% / ("+this.dayCount+" * "+m.length+") - "+k+"px)";X.params.wrapNode.style.left="calc(100% * "+u+"/ "+m.length+" + "+X.absoluteLeftOffset+"px)"}}this.checkTimelineEntrySize(X,D,true)}}}};i.prototype.fillTimelineMap=function(e,t,i){var s,a=t.from.getHours()*60+t.from.getMinutes(),r=t.to.getHours()*60+t.to.getMinutes();for(s=a;s<r;s++){if(!e[s])e[s]=[];e[s].push(i)}};i.prototype.displayTopEntry=function(e){var t,i=e.entry,s=e.part.from,a=e.part.daysCount,r,n,o,l,d,h,p,c="calendar-event-line-wrap",f=0,u,m;if(i.isFullDay()){c+=" calendar-event-line-fill"}else if(i.isLongWithTime()){c+=" calendar-event-line-border"}if(i.isExternal()){c+=" calendar-event-line-intranet"}if(this.util.getDayCode(i.from)!==this.util.getDayCode(s.date)){c+=" calendar-event-line-start-yesterday";f+=8;u=this.getArrow("left",i.color,i.isFullDay())}if(this.util.getDayCode(i.to)!==this.util.getDayCode(e.part.to.date)){c+=" calendar-event-line-finish-tomorrow";m=this.getArrow("right",i.color,i.isFullDay());f+=12}if(u&&!m){f+=4}if(f==0){f=5}r=BX.create("DIV",{attrs:{"data-bx-calendar-entry":i.uid},props:{className:c},style:{top:0,left:this.dayCount>1?"calc((100% / "+this.dayCount+") * ("+(s.dayOffset+1)+" - 1) + 2px)":"2px",width:"calc("+a+" * 100% / "+this.dayCount+" - "+f+"px)"}});if(u){r.appendChild(u);r.style.left="9px"}if(m){r.appendChild(m)}p=r.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner-container"}}));o=p.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner"}}));n=o.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-dot"}}));if(i.isFullDay()){o.style.maxWidth="calc(200% / "+a+" - "+this.lastEntryWidthOffset+"px)"}else if(i.isLongWithTime()){r.style.borderColor=i.color;o.style.maxWidth="calc(200% / "+a+" - "+this.lastEntryWidthOffset+"px)";if(e.part.partIndex==0){if(a>1){d=o.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(i.from.getHours(),i.from.getMinutes())}))}o.style.width="calc(100% / "+a+" - "+this.lastEntryWidthOffset+"px)"}if(!d&&a==1&&this.util.getDayCode(i.from)==e.part.from.dayCode){d=o.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(i.from.getHours(),i.from.getMinutes())}))}if(e.part.partIndex==i.parts.length-1){if(a>1&&i.parts.length>1){o.style.width="calc("+(a-1)+"00% / "+a+" - "+this.lastEntryWidthOffset+"px)"}if(a>1){h=o.appendChild(BX.create("SPAN",{props:{className:i.parts.length>1&&a==1?"calendar-event-line-time":"calendar-event-line-expired-time"},text:this.calendar.util.formatTime(i.to.getHours(),i.to.getMinutes())}))}}if(!h&&a==1&&this.util.getDayCode(i.to)==e.part.to.dayCode){h=o.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(i.to.getHours(),i.to.getMinutes())}))}}else{d=o.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(i.from.getHours(),i.from.getMinutes())}))}l=o.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-text"},text:e.entry.name}));if(i.isFullDay()){p.style.backgroundColor=this.calendar.util.hexToRgba(i.color,.3);p.style.borderColor=this.calendar.util.hexToRgba(i.color,.3)}else{if(i.isLongWithTime()){p.style.borderColor=this.calendar.util.hexToRgba(i.color,.5)}n.style.backgroundColor=i.color}this.topEntryHolder.appendChild(r);t={wrapNode:r,nameNode:l,innerNode:o,innerContainer:p,timeNode:d||false,endTimeNode:h||false,dotNode:n};if(!e.popupMode){e.entry.registerPartNode(e.part,t)}this.calendar.dragDrop.registerEntry(r,e);return t};i.prototype.displayTopEntries=function(){var e;for(e=0;e<this.partsStorage.length;e++){this.displayTopEntry(this.partsStorage[e])}};i.prototype.displayTimelineEntries=function(){this.zIndexTimeline=100;this.timelinePartsStorage.sort(function(e,t){if(e.part.fromTimeValue==t.part.fromTimeValue)return t.part.toTimeValue-t.part.fromTimeValue-(e.part.toTimeValue-e.part.fromTimeValue);return e.part.fromTimeValue-t.part.fromTimeValue});var e;for(e=0;e<this.timelinePartsStorage.length;e++){this.displayTimelineEntry(this.timelinePartsStorage[e])}};i.prototype.displayTimelineEntry=function(e){var t=false,i,s,a,r,n,o,l,d,h,p=this.util.getWorkTime(),c=e.entry,f=e.part.from,u=e.part.fromTimeValue,m=e.part.toTimeValue,y="calendar-event-block-wrap";if(c.isExternal()){y+=" calendar-event-block-intranet"}if(!this.collapseOffHours||m>p.start&&u<p.end){if(this.collapseOffHours){u=Math.max(e.part.fromTimeValue,p.start);m=Math.min(e.part.toTimeValue,p.end);i=(u-p.start)*this.gridLineHeight+1+"px"}else{i=u*this.gridLineHeight+1+"px"}s=BX.create("DIV",{attrs:{"data-bx-calendar-entry":c.uid},props:{className:y},style:{top:i,height:(m-u)*this.gridLineHeight-3+"px",left:this.dayCount>1?"calc((100% / "+this.dayCount+") * "+f.dayOffset+" + 2px)":"2px",width:"calc(100% / "+this.dayCount+" - "+this.lastEntryWidthOffset+"px)"}});h=s.appendChild(BX.create("DIV",{props:{className:"calendar-event-block-border"}}));a=s.appendChild(BX.create("DIV",{props:{className:"calendar-event-block-inner"}}));d=a.appendChild(BX.create("DIV",{props:{className:"calendar-event-block-background"}}));o=this.calendar.util.formatTime(c.from)+" &ndash; "+this.calendar.util.formatTime(c.to);n=a.appendChild(BX.create("SPAN",{props:{className:"calendar-event-block-time"},html:o+'<span class="calendar-event-block-time-shadow">'+o+"</span>"}));r=a.appendChild(BX.create("SPAN",{props:{className:"calendar-event-block-text"},text:e.entry.name}));h.style.backgroundColor=c.color;d.style.backgroundColor=c.color;if(this.calendar.entryController.canDo(c,"edit")){l=s.appendChild(BX.create("DIV",{props:{className:"calendar-event-resizer"}}))}this.timelineEntryHolder.appendChild(s);t={wrapNode:s,nameNode:r,innerNode:a,timeNode:n,blockBackgroundNode:d,resizerNode:l};e.part.offsetFractionRate=1;e.part.offsetFractionLeft=0;e.part.offsetFractionWidth=1;e.part.offsetFractionLeftTotal=0;e.entry.registerPartNode(e.part,t);this.calendar.dragDrop.registerEntry(s,e)}return t};i.prototype.checkTimelineEntrySize=function(e,t,i){if(e.params.innerNode.offsetHeight){this.setEntryBlockCompact(e,t)}if(i===true){setTimeout(BX.proxy(function(){this.checkTimelineEntrySize(e,t,false)},this),100)}};i.prototype.setEntryBlockCompact=function(e,t){var i,s,a,r=16,n=23,o=60,l=e.params.nameNode,d=e.params.innerNode,h=d.offsetWidth,p=parseInt(l.style.maxHeight);if(p){i=Math.floor(Math.min(d.offsetHeight-n,p)/r)}else{i=Math.floor((d.offsetHeight-n)/r)}if(p||l.offsetHeight+n>d.offsetHeight||h<o){if(i<1||h<o){s=t.entry&&t.entry.from?t.entry.from:t.from;if(s){a=this.calendar.util.formatTime(s.getHours(),s.getMinutes());e.params.timeNode.innerHTML=a+'<span class="calendar-event-block-time-shadow">'+a+"</span>"}BX.addClass(e.params.wrapNode,"calendar-event-block-compact");if(h<o)BX.addClass(e.params.wrapNode,"narrow-block")}else if(i==1){l.style.whiteSpace="nowrap";l.style.display="block"}else{if(BX.browser.IsChrome()){l.style.WebkitLineClamp=i;l.style.display="-webkit-box"}else{l.style.height=i*r+"px"}}}};i.prototype.showNowTime=function(e){this.nowTimeCont=e.appendChild(BX.create("DIV",{props:{className:this.gridNowTimeClass}}));this.nowTimeLine=this.nowTimeCont.appendChild(BX.create("DIV",{props:{className:this.gridNowTimeLineClass}}));this.nowTimeLine.appendChild(BX.create("DIV",{props:{className:this.gridNowTimeDotClass}}));this.nowTimeLabel=this.nowTimeCont.appendChild(BX.create("DIV",{props:{className:this.gridNowTimeLabelClass}}));if(this.nowTimeInterval)clearInterval(this.nowTimeInterval);this.updateNowTime();this.nowTimeInterval=setInterval(BX.proxy(this.updateNowTime,this),15e3)};i.prototype.hideNowTime=function(){BX.cleanNode(this.nowTimeCont,1);delete this.nowTimeCont;if(this.nowTimeInterval)clearInterval(this.nowTimeInterval)};i.prototype.updateNowTime=function(){if(!this.nowTimeCont)return;var e=10,t=15,i=this.util.getWorkTime(),s=new Date,a=this.getViewRange(),r=this.util.getTimeValue(s),n=true,o=Math.round(r);var l=document.querySelector("."+this.gridTimeTranslucentClass);if(l)BX.removeClass(l,this.gridTimeTranslucentClass);if(s.getTime()>a.start.getTime()&&s.getTime()<a.end.getTime()){if(!this.nowTimeCont)this.showNowTime();if(this.dayCount>1){var d=this.util.getWeekDayOffset(this.util.getWeekDayByInd(s.getDay()));if(d==0){this.nowTimeLine.style.left=0}else{this.nowTimeLine.style.left="calc("+d+" * 100% / "+this.dayCount+")"}}}else{return this.hideNowTime()}var h=this.calendar.util.formatTime(s.getHours(),s.getMinutes());if(BX.isAmPmMode())h=h.replace(/(\sam|pm)/gi,"<small>$1<small>");this.nowTimeLabel.innerHTML=h;if(this.collapseOffHours){if(r<i.start){n=false;this.nowTimeLabel.style.display="none";this.nowTimeCont.style.top="-5px"}else if(r>i.end){n=false;this.nowTimeLabel.style.display="none";this.nowTimeCont.style.top=(i.end-i.start)*this.gridLineHeight+4+"px"}else{if(r<i.start+e/this.gridLineHeight||r>i.end-e/this.gridLineHeight){this.nowTimeLabel.style.display="none"}else{this.nowTimeLabel.style.display=""}this.nowTimeCont.style.top=(r-i.start)*this.gridLineHeight+1+"px"}}else{if(r<i.start+t/this.gridLineHeight&&r>i.start||r>i.end-t/this.gridLineHeight&&r<i.end){n=false;this.nowTimeLabel.style.display="none"}this.nowTimeCont.style.top=r*this.gridLineHeight+1+"px"}if(n&&Math.abs((o-r)*this.gridLineHeight)<e){if(this.timeLinesIndex[o]){BX.addClass(this.timeLinesIndex[o],this.gridTimeTranslucentClass)}}};i.prototype.getTimeByPos=function(e,t){var i=this.util.getWorkTime(),s=e/this.gridLineHeight,a=this.util.getTimeByFraction(s,t||10);if(this.collapseOffHours){a.h+=i.start}return a};i.prototype.showOffHours=function(){var e=this.util.getWorkTime();this.topOffHours=this.timeLinesCont.appendChild(BX.create("DIV",{props:{className:this.offHoursClass+" "+this.offHoursAnimateClass},style:{top:0,height:e.start*this.gridLineHeight+1+"px"}}));this.topOffHoursLabel=this.topOffHours.appendChild(BX.create("DIV",{props:{className:this.gridTimelineHourLabelClass},children:[BX.create("DIV",{props:{className:this.gridTimelineHourLabelClassInner},html:this.calendar.util.formatTime(0,0,true)+"<br>"+this.calendar.util.formatTime(e.start,0,true)})]}));this.topOffHours.appendChild(BX.create("DIV",{props:{className:"calendar-grid-off-hours-active"},events:{click:BX.proxy(this.switchOffHours,this),mouseover:BX.proxy(function(){BX.addClass(this.topOffHours,"calendar-grid-off-hours-hover");BX.addClass(this.bottomOffHours,"calendar-grid-off-hours-hover")},this),mouseout:BX.proxy(function(){BX.removeClass(this.topOffHours,"calendar-grid-off-hours-hover");BX.removeClass(this.bottomOffHours,"calendar-grid-off-hours-hover")},this)}}));this.topOffHours.appendChild(BX.create("DIV",{props:{className:"calendar-grid-off-hours-drag-down"},attrs:{"data-bx-calendar-off-time-drag":"top"},events:{mousedown:BX.proxy(this.offHoursMousedown,this)}}));this.bottomOffHours=this.timeLinesCont.appendChild(BX.create("DIV",{props:{className:this.offHoursClass+" "+this.offHoursAnimateClass},style:{top:e.end*this.gridLineHeight+1+"px",height:(24-e.end)*this.gridLineHeight+1+"px"}}));this.bottomOffHoursLabel=this.bottomOffHours.appendChild(BX.create("DIV",{props:{className:this.gridTimelineHourLabelClass},children:[BX.create("DIV",{props:{className:this.gridTimelineHourLabelClassInner},html:this.calendar.util.formatTime(e.end,0,true)+"<br>"+this.calendar.util.formatTime(24,0,true)})]}));this.bottomOffHours.appendChild(BX.create("DIV",{props:{className:"calendar-grid-off-hours-active"},events:{click:BX.proxy(this.switchOffHours,this),mouseover:BX.proxy(function(){BX.addClass(this.topOffHours,"calendar-grid-off-hours-hover");BX.addClass(this.bottomOffHours,"calendar-grid-off-hours-hover")},this),mouseout:BX.proxy(function(){BX.removeClass(this.topOffHours,"calendar-grid-off-hours-hover");BX.removeClass(this.bottomOffHours,"calendar-grid-off-hours-hover")},this)}}));this.bottomOffHours.appendChild(BX.create("DIV",{props:{className:"calendar-grid-off-hours-drag-up"},attrs:{"data-bx-calendar-off-time-drag":"bottom"},events:{mousedown:BX.proxy(this.offHoursMousedown,this)}}));BX.bind(this.topOffHours,"click",BX.proxy(function(){if(this.collapseOffHours){this.switchOffHours(true)}},this));BX.bind(this.bottomOffHours,"click",BX.proxy(function(){if(this.collapseOffHours){this.switchOffHours(true)}},this));if(this.collapseOffHours){this.gridRow.style.height=this.gridLineHeight*(e.end-e.start)+30+"px";this.collapseOffHours=!this.collapseOffHours;this.switchOffHours(false);this.updateGridRowShadowHeight()}else{this.gridRow.style.height=this.gridLineHeight*24+40+"px";this.updateGridRowShadowHeight()}};i.prototype.offHoursMousedown=function(e){var t=e.target||e.srcElement;this.lastWorkTime=false;this.lastTopCount=false;if(t&&t.getAttribute){this.lastWorkTime=BX.clone(this.util.getWorkTime());BX.unbind(document,"mousemove",BX.proxy(this.offHoursMousemove,this));BX.unbind(document,"mouseup",BX.proxy(this.offHoursMouseup,this));BX.bind(document,"mousemove",BX.proxy(this.offHoursMousemove,this));BX.bind(document,"mouseup",BX.proxy(this.offHoursMouseup,this));BX.removeClass(this.topOffHours,this.offHoursAnimateClass);BX.removeClass(this.bottomOffHours,this.offHoursAnimateClass);BX.addClass(this.topOffHours,this.offHoursFastAnimateClass);BX.addClass(this.bottomOffHours,this.offHoursFastAnimateClass);if(t.getAttribute("data-bx-calendar-off-time-drag")=="top"){this.offtimeTuneMode="top"}else{this.offtimeTuneMode="bottom"}this.offtimeTuneBaseZeroPos=BX.pos(this.timeLinesCont).top}};i.prototype.offHoursMousemove=function(e){if(this.offtimeTuneMode){var t=this.util.getMousePos(e),i=Math.max(Math.round((t.y-this.offtimeTuneBaseZeroPos)/this.gridLineHeight),0);if(this.lastTopCount!==i){if(this.offtimeTuneMode=="top"){i=Math.min(this.lastWorkTime.end-1,i);this.topOffHours.style.height=i*this.gridLineHeight+1+"px";this.lastWorkTime.start=i}else{i=Math.max(this.lastWorkTime.start+1,i);this.bottomOffHours.style.top=i*this.gridLineHeight+"px";this.bottomOffHours.style.height=(24-i)*this.gridLineHeight+1+"px";this.lastWorkTime.end=i}this.lastTopCount=i}}};i.prototype.offHoursMouseup=function(){BX.unbind(document,"mousemove",BX.proxy(this.offHoursMousemove,this));BX.unbind(document,"mouseup",BX.proxy(this.offHoursMouseup,this));BX.addClass(this.topOffHours,this.offHoursAnimateClass);BX.addClass(this.bottomOffHours,this.offHoursAnimateClass);BX.removeClass(this.topOffHours,this.offHoursFastAnimateClass);BX.removeClass(this.bottomOffHours,this.offHoursFastAnimateClass);var e=this.util.setWorkTime(this.lastWorkTime);this.topOffHoursLabel.innerHTML=this.calendar.util.formatTime(0,0,true)+"<br>"+this.calendar.util.formatTime(e.start,0,true);this.bottomOffHoursLabel.innerHTML=this.calendar.util.formatTime(e.end,0,true)+"<br>"+this.calendar.util.formatTime(24,0,true);this.offtimeTuneMode=false;delete this.lastWorkTime;delete this.lastTopCount;this.collapseOffHours=false;this.switchOffHours(true)};i.prototype.switchOffHours=function(e){if(this.denySwitch)return;e=e!==false;if(this.nowTimeCont)this.nowTimeCont.display="none";BX.cleanNode(this.timelineEntryHolder);this.hideNowTime();if(e){BX.removeClass(this.grid,"calendar-events-holder-show");BX.addClass(this.bottomOffHours,this.offHoursAnimateClass);BX.addClass(this.topOffHours,this.offHoursAnimateClass);BX.addClass(this.timeLinesCont,this.offHoursAnimateClass)}else{BX.removeClass(this.bottomOffHours,this.offHoursAnimateClass);BX.removeClass(this.topOffHours,this.offHoursAnimateClass);BX.removeClass(this.timeLinesCont,this.offHoursAnimateClass)}this.denySwitch=true;var t=this,i=300,s,a,r=this.util.getWorkTime();setTimeout(BX.delegate(function(){this.denySwitch=false;if(this.collapseOffHours){}else{for(s in this.timeLinesIndex){if(this.timeLinesIndex.hasOwnProperty(s)){this.timeLinesIndex[s].style.opacity="";this.timeLinesIndex[s].style.display=""}}}BX.addClass(this.bottomOffHours,this.offHoursAnimateClass);BX.addClass(this.topOffHours,this.offHoursAnimateClass);BX.addClass(this.timeLinesCont,this.offHoursAnimateClass);if(this.scrollTopInterval)clearTimeout(this.scrollTopInterval);if(this.timeLinesCont&&!this.nowTimeCont)this.showNowTime(this.timeLinesCont);if(e){BX.addClass(this.grid,"calendar-events-holder-show");this.displayEntries()}},this),e?500:10);function n(t){if(e){setTimeout(function(){t.style.opacity=1},i)}else{t.style.opacity=1}}function o(t){if(e){setTimeout(function(){t.style.display="none"},i)}else{t.style.display="none"}}function l(){t.gridWrap.scrollTop=t.savedScrollTop||r.start*t.gridLineHeight-5;t.scrollTopInterval=setTimeout(l,5)}var d=true;if(!this.collapseOffHours&&(r.end-r.start)*this.gridLineHeight+20<=this.util.getViewHeight()){d=false}this.checkTimelineScroll(d);if(this.collapseOffHours){this.gridRow.style.height=this.gridLineHeight*24+40+"px";this.topOffHours.style.height=this.gridLineHeight*r.start+1+"px";this.bottomOffHours.style.height=this.gridLineHeight*(24-r.end)+1+"px";this.bottomOffHours.style.top=this.gridLineHeight*r.end+"px";for(s in this.timeLinesIndex){if(this.timeLinesIndex.hasOwnProperty(s)){if(s>=r.start&&s<=r.end){o(this.timeLinesIndex[s])}else{this.timeLinesIndex[s].style.display="block";n(this.timeLinesIndex[s])}this.timeLinesIndex[s].style.top=s*this.gridLineHeight+"px"}}if(e&&this.savedScrollTop){this.scrollTopInterval=setTimeout(l,5)}}else{this.gridRow.style.height=this.gridLineHeight*(r.end-r.start)+30+"px";this.topOffHours.style.height="10px";this.bottomOffHours.style.height=this.gridLineHeight*(24-r.end)+1+"px";this.bottomOffHours.style.top=this.gridLineHeight*r.end+"px";for(s in this.timeLinesIndex){if(this.timeLinesIndex.hasOwnProperty(s)){if(s<=r.start||s>=r.end){a=this.timeLinesIndex[s];this.timeLinesIndex[s].style.opacity=0;o(this.timeLinesIndex[s])}else{n(this.timeLinesIndex[s])}if(s>=r.end){this.timeLinesIndex[s].style.top=(r.end-r.start)*this.gridLineHeight+"px"}else{this.timeLinesIndex[s].style.top=(s-r.start)*this.gridLineHeight+"px"}}}this.bottomOffHours.style.height="10px";this.bottomOffHours.style.top=(r.end-r.start)*this.gridLineHeight+9+"px";this.savedScrollTop=parseInt(this.gridWrap.scrollTop)}this.collapseOffHours=!this.collapseOffHours;BX.toggleClass(this.topOffHours,[this.offHoursCollapseClass,this.offHoursClass]);BX.toggleClass(this.bottomOffHours,[this.offHoursCollapseClass,this.offHoursClass]);this.util.setUserOption("collapseOffHours",this.collapseOffHours?"Y":"N");this.updateGridRowShadowHeight()};i.prototype.checkTimelineScroll=function(e){var t=e?this.util.getScrollbarWidth():0;if(this.titleCont){this.titleCont.style.paddingRight=t+"px"}if(this.fullDayEventsHolderCont&&this.topEntryHolder){new BX.easing({duration:100,start:{width:t,paddingRight:0},finish:{width:0,paddingRight:t},transition:BX.easing.makeEaseOut(BX.easing.transitions.linear),step:BX.delegate(function(e){this.gridWrap.style.width="calc(100% + "+e.width+"px)";this.topEntryHolder.style.right=e.paddingRight+"px";this.fullDayEventsHolderCont.style.paddingRight=e.paddingRight+"px"},this),complete:function(){}}).animate()}};i.prototype.getDayGridHeight=function(){return 1040};i.prototype.updateGridRowShadowHeight=function(){if(this.collapseOffHours){this.gridRowShadow.style.height=parseInt(this.gridRow.style.height)-38+"px";BX.removeClass(this.gridRowShadow,"calendar-grid-week-row-shadow-off-hours")}else{this.gridRowShadow.style.height=parseInt(this.gridRow.style.height)-40+"px";BX.addClass(this.gridRowShadow,"calendar-grid-week-row-shadow-off-hours")}};i.prototype.handleClick=function(e){if(this.isActive()){if(!e)e={};var t,i;if(e.specialTarget&&(i=e.specialTarget.getAttribute("data-bx-calendar-entry"))){this.handleEntryClick({uid:i,specialTarget:e.specialTarget,target:e.target,e:e.e})}else if(e.specialTarget&&(t=e.specialTarget.getAttribute("data-bx-calendar-show-all-events"))){}else if(!this.calendar.util.readOnlyMode()&&this.entryController.canDo(true,"add_event")&&(t=e.specialTarget&&e.specialTarget.getAttribute("data-bx-calendar-week-day"))){this.deselectEntry();this.showSimplePopupForNewEntry({entry:this.buildTopNewEntryWrap({dayFrom:this.days[this.dayIndex[t]],holder:this.topEntryHolder})})}}};i.prototype.handleMousedown=function(e){if(!this.isActive())return;var t,i=this.calendar.util.findTargetNode(e.target||e.srcElement);if(!this.calendar.util.readOnlyMode()&&this.entryController.canDo(true,"add_event")&&(t=i&&i.getAttribute("data-bx-calendar-timeline-day"))){BX.unbind(document,"mousemove",BX.proxy(this.handleMousemove,this));BX.unbind(document,"mouseup",BX.proxy(this.handleMouseup,this));BX.bind(document,"mousemove",BX.proxy(this.handleMousemove,this));BX.bind(document,"mouseup",BX.proxy(this.handleMouseup,this));BX.addCustomEvent(this.calendar,"keyup",BX.proxy(this.checkKeyup,this));this.createEntryMode=true;this.offtimeTuneBaseZeroPos=BX.pos(this.timeLinesCont).top;this.offtimeBottomBasePos=BX.pos(this.bottomOffHours).bottom-2;this.startMousePos=Math.max(this.offtimeTuneBaseZeroPos+this.gridWrap.scrollTop,this.calendar.util.getMousePos(e).y);this.newEntry=this.buildTimelineNewEntryWrap({dayFrom:this.days[this.dayIndex[t]],holder:this.timelineEntryHolder});this.newEntry.dayFrom=this.days[this.dayIndex[t]];this.newEntry.timeFrom=this.getTimeByPos(this.startMousePos-this.offtimeTuneBaseZeroPos,30,true);var s=this.util.getWorkTime(),a=this.newEntry.timeFrom.h+this.newEntry.timeFrom.m/60;if(this.collapseOffHours){a=Math.max(a,s.start);this.startMousePos=this.offtimeTuneBaseZeroPos+((a-s.start)*this.gridLineHeight+1)}else{this.startMousePos=this.offtimeTuneBaseZeroPos+(a*this.gridLineHeight+1)}if(this.newEntry.timeFrom.h==23)this.newEntry.timeTo={h:23,m:59};else this.newEntry.timeTo={h:this.newEntry.timeFrom.h+1,m:this.newEntry.timeFrom.m};this.newEntry.changeTimeCallback(this.newEntry.timeFrom,this.newEntry.timeTo);this.newEntry.entryNode.style.top=this.startMousePos+"px"}};i.prototype.handleMousemove=function(e){if(this.createEntryMode){var t=this.calendar.util.getMousePos(e).y,i=Math.min(Math.max(t-this.startMousePos,10),this.offtimeBottomBasePos-parseInt(this.newEntry.entryNode.style.top));this.newEntry.entryNode.style.height=i+"px";this.newEntry.timeTo=this.getTimeByPos(i+this.startMousePos-this.offtimeTuneBaseZeroPos);this.newEntry.changeTimeCallback(this.newEntry.timeFrom,this.newEntry.timeTo)}};i.prototype.handleMouseup=function(e){BX.unbind(document,"mousemove",BX.proxy(this.offHoursMousemove,this));BX.unbind(document,"mouseup",BX.proxy(this.offHoursMouseup,this));BX.removeCustomEvent(this.calendar,"keyup",BX.proxy(this.checkKeyup,this));if(this.createEntryMode){var t=new Date(this.newEntry.dayFrom.date.getTime()),i=new Date(this.newEntry.dayFrom.date.getTime());t.setHours(this.newEntry.timeFrom.h,this.newEntry.timeFrom.m,0,0);i.setHours(this.newEntry.timeTo.h,this.newEntry.timeTo.m,0,0);this.deselectEntry();this.showSimplePopupForNewEntry({entry:this.newEntry,entryTime:{from:t,to:i}});this.createEntryMode=false}};i.prototype.checkKeyup=function(e){var t=this.util.getKeyCodes();if(e.keyCode==t["escape"]&&this.createEntryMode&&this.newEntry){BX.remove(this.newEntry.entryNode);this.createEntryMode=false;this.handleMouseup()}};i.prototype.buildTopNewEntryWrap=function(e){var t=this,i,s,a,r,n,o="calendar-event-line-wrap",l=0,d=e.dayFrom,h,p,c=1,f=this.calendar.sectionController.getCurrentSection(),u=f.color;i=this.entryController.getTimeForNewEntry(d.date);s=this.entryController.getDefaultEntryName();a=e.holder.appendChild(BX.create("DIV",{props:{className:o},style:{top:0,left:this.dayCount>1?"calc((100% / "+this.dayCount+") * ("+(d.dayOffset+1)+" - 1) + 2px)":"2px",width:"calc("+c+" * 100% / "+this.dayCount+" - "+l+"px)"}}));n=a.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner-container"}}));r=n.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner"}}));r.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(i.from.getHours(),i.from.getMinutes())}));r.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-text"},text:s}));a.style.backgroundColor=u;a.style.borderColor=u;a.style.opacity=0;var m=BX.pos(a);var y=BX.adjust(document.body.appendChild(a.cloneNode(true)),{props:{className:"calendar-event-line-clone"},style:{width:m.width+1+"px",height:m.height+"px",top:m.top+"px",left:m.left+"px",opacity:1}});if(a){BX.remove(a,true)}p=y.querySelector(".calendar-event-line-text");h=y.querySelector(".calendar-event-line-time");r=y.querySelector(".calendar-event-line-inner");var g={entryNode:y,innerNode:r,section:f,entryName:s,entryTime:i,changeTimeCallback:function(e,i){if(e.getHours&&i.getHours){h.innerHTML=t.calendar.util.formatTime(e.getHours(),e.getMinutes())}else{h.innerHTML=t.calendar.util.formatTime(e.h,e.m)}},changeNameCallback:function(e){p.innerHTML=BX.util.htmlspecialchars(e)}};this.selectEntryPart(g,u,false);return g};i.prototype.buildTimelineNewEntryWrap=function(e){var t=this,i,s,a,r,n="calendar-event-block-wrap",o=e.dayFrom,l,d,h,p,c,f,u=this.calendar.sectionController.getCurrentSection(),m=u.color;i=this.entryController.getTimeForNewEntry(o.date);s=this.entryController.getDefaultEntryName();a=e.holder.appendChild(BX.create("DIV",{props:{className:n},style:{top:top,height:this.gridLineHeight+"px",minHeight:"20px",left:this.dayCount>1?"calc((100% / "+this.dayCount+") * "+o.dayOffset+" + 2px)":"2px",width:"calc(100% / "+this.dayCount+" - "+this.lastEntryWidthOffset+"px)"}}));l=a.appendChild(BX.create("DIV",{props:{className:"calendar-event-block-border"}}));r=a.appendChild(BX.create("DIV",{props:{className:"calendar-event-block-inner"}}));d=r.appendChild(BX.create("DIV",{props:{className:"calendar-event-block-background"}}));h=this.calendar.util.formatTime(i.from.getHours(),i.from.getMinutes())+" &ndash; "+this.calendar.util.formatTime(i.to.getHours(),i.to.getMinutes());r.appendChild(BX.create("SPAN",{props:{className:"calendar-event-block-time"},style:{color:"#fff"},html:h+'<span class="calendar-event-block-time-shadow">'+h+"</span>"}));r.appendChild(BX.create("SPAN",{props:{className:"calendar-event-block-text"},style:{color:"#fff"},text:s}));l.style.backgroundColor=m;d.style.backgroundColor=m;var y=BX.pos(a);var g=BX.adjust(document.body.appendChild(a.cloneNode(true)),{props:{className:"calendar-event-line-clone calendar-event-block-wrap active"},style:{width:y.width+1+"px",height:y.height+"px",top:y.top+"px",left:y.left+"px",opacity:1}});if(a){BX.remove(a,true)}c=g.querySelector(".calendar-event-block-text");p=g.querySelector(".calendar-event-block-time");r=g.querySelector(".calendar-event-block-inner");l=g.querySelector(".calendar-event-block-border");d=g.querySelector(".calendar-event-block-background");f=g.appendChild(BX.create("DIV",{props:{className:"calendar-event-bind-node"}}));if(this.dayCount==1)f.style.right="10%";else f.style.left="0";var C={entryNode:g,innerNode:r,section:u,entryName:s,bindNode:f,borderNode:l,blockBackgroundNode:d,changeTimeCallback:function(e,i){var s;if(e.getHours&&i.getHours){s=t.calendar.util.formatTime(e.getHours(),e.getMinutes())+" &ndash; "+t.calendar.util.formatTime(i.getHours(),i.getMinutes())}else{s=t.calendar.util.formatTime(e.h,e.m)+" &ndash; "+t.calendar.util.formatTime(i.h,i.m)}p.innerHTML=s+'<span class="calendar-event-block-time-shadow">'+s+"</span>"},changeNameCallback:function(e){c.innerHTML=BX.util.htmlspecialchars(e)}};this.selectEntryPart(C,m,false);return C};i.prototype.showSimplePopupForNewEntry=function(e){this.showSimplePopup({entryNode:e.entry.entryNode,bindNode:e.entry.bindNode,section:e.entry.section,entryTime:e.entryTime||e.entry.entryTime,entryName:e.entry.entryName,changeTimeCallback:e.entry.changeTimeCallback,changeNameCallback:e.entry.changeNameCallback,closeCallback:BX.delegate(function(){BX.remove(e.entry.entryNode)},this),changeDateCallback:BX.delegate(function(e){},this),changeSectionCallback:function(t){var i=t.color;if(e.entry.borderNode)e.entry.borderNode.style.backgroundColor=i;if(e.entry.blockBackgroundNode)e.entry.blockBackgroundNode.style.backgroundColor=i},saveCallback:function(){},cancelCallback:function(){},fullFormCallback:BX.delegate(this.showEditSlider,this)})};function s(){t.apply(this,arguments);this.initConfig();this.preBuild()}s.prototype=Object.create(i.prototype);s.prototype.constructor=s;s.prototype.show=function(){t.prototype.show.apply(this,arguments);this.buildDaysGrid();if(this.calendar.navCalendar)this.calendar.navCalendar.hide();this.displayEntries();this.calendar.initialViewShow=false};s.prototype.initConfig=function(){i.prototype.initConfig.apply(this,arguments);this.name="week";this.title=BX.message("EC_VIEW_WEEK");this.contClassName="calendar-week-view";this.gridWrapClass="calendar-grid-wrap";this.fullDayContClass="calendar-grid-week-full-days-events-holder";this.outerGridClass="calendar-grid-week-container";this.gridClass="calendar-grid-week";this.gridClassCurrent="calendar-grid-week-current";this.gridClassNext="calendar-grid-week-left-slide";this.gridClassPrevious="calendar-grid-week-right-slide";this.changeNextClass="calendar-change-week-left-slide";this.changePreviousClass="calendar-change-week-right-slide";this.gridRowClass="calendar-grid-week-row";this.gridCellClass="calendar-grid-week-cell";this.gridTimelinesClass="calendar-grid-week-time-lines";this.gridTimelineHourClass="calendar-grid-week-time-line-hour";this.gridTimelineHourLabelClass="calendar-grid-week-time-line-hour-label";this.topEntryHolderClass="calendar-grid-week-events-holder";this.gridNowTimeClass="calendar-grid-week-time-line-hour-now";this.gridNowTimeLabelClass="calendar-grid-week-time-line-hour-label";this.gridNowTimeLineClass="calendar-grid-week-time-line-hour-now-line";this.gridNowTimeDotClass="calendar-grid-week-time-line-hour-now-dot";this.dayCount=7};s.prototype.setTitle=function(){var e=this.calendar.getViewRangeDate(),i=e.getTime(),s=new Date(e.getTime()+this.dayCount*this.calendar.util.dayLength);if(e.getMonth()!=s.getMonth()){t.prototype.setTitle.apply(this,[BX.date.format("f",i/1e3)+" - "+BX.date.format("f",s.getTime()/1e3)+(this.util.showWeekNumber()?", #GRAY_START#"+BX.message("EC_DATE_WEEK_NUMBER").replace("#WEEK_NUMBER#",this.util.getWeekNumber(i))+"#GRAY_END#":"")])}else{t.prototype.setTitle.apply(this,[BX.date.format("f",i/1e3)+(this.util.showWeekNumber()?", #GRAY_START#"+BX.message("EC_DATE_WEEK_NUMBER").replace("#WEEK_NUMBER#",this.util.getWeekNumber(i))+"#GRAY_END#":"")])}};s.prototype.getAdjustedDate=function(e,t,s){if(!e){e=new Date}if(t&&e.getTime()<t.start.getTime()){e=new Date(t.start.getTime())}if(t&&e.getTime()>t.end.getTime()){e=new Date(t.end.getTime())}var a=this.util.getWeekStart();while(this.util.getWeekDayByInd(e.getDay())!=a){e.setDate(e.getDate()-1)}if(s){t.start.setDate(e.getTime());t.end.setDate(e.getTime()+this.calendar.util.dayLength*this.dayCount)}return i.prototype.getAdjustedDate.apply(this,[e,t])};s.prototype.adjustViewRangeToDate=function(e){var t=this.util.getWeekStart();while(this.util.getWeekDayByInd(e.getDay())!=t){e.setDate(e.getDate()-1)}return i.prototype.adjustViewRangeToDate.apply(this,[e])};function a(){t.apply(this,arguments);this.name="month";this.title=BX.message("EC_VIEW_MONTH");this.contClassName="calendar-month-view";this.dayCount=7;this.slotHeight=20;this.eventHolderTopOffset=25;this.preBuild()}a.prototype=Object.create(t.prototype);a.prototype.constructor=a;a.prototype.preBuild=function(){this.viewCont=BX.create("DIV",{props:{className:this.contClassName},style:{display:"none"}})};a.prototype.build=function(){this.titleCont=this.viewCont.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month-row-days-week"}}));this.gridWrap=this.viewCont.appendChild(BX.create("DIV",{props:{className:"calendar-grid-wrap"}}));this.gridMonthContainer=this.gridWrap.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month-container"}}));this.grid=this.gridMonthContainer.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month calendar-grid-month-current"}}))};a.prototype.show=function(){t.prototype.show.apply(this,arguments);this.buildDaysTitle();this.buildDaysGrid();if(this.calendar.navCalendar)this.calendar.navCalendar.hide();this.displayEntries();this.calendar.initialViewShow=false};a.prototype.hide=function(){t.prototype.hide.apply(this,arguments)};a.prototype.increaseViewRangeDate=function(){this.changeViewRangeDate(1);var e=this.gridMonthContainer.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month calendar-grid-month-next"+" "+this.animateClass}}));BX.addClass(this.grid,this.animateClass);this.setTitle();this.buildDaysGrid({grid:e});this.preloadEntries();setTimeout(BX.delegate(function(){BX.addClass(this.gridMonthContainer,"calendar-change-month-next");setTimeout(BX.delegate(function(){BX.removeClass(this.gridMonthContainer,"calendar-change-month-next");BX.removeClass(e,"calendar-grid-month-next");BX.addClass(e,"calendar-grid-month-current");BX.remove(this.grid);this.grid=e;BX.removeClass(this.grid,this.animateClass);this.displayEntries()},this),400)},this),0)};a.prototype.decreaseViewRangeDate=function(){this.changeViewRangeDate(-1);var e=this.gridMonthContainer.insertBefore(BX.create("DIV",{props:{className:"calendar-grid-month calendar-grid-month-previous"+" "+this.animateClass}}),this.grid);BX.addClass(this.grid,this.animateClass);this.setTitle();this.buildDaysGrid({grid:e});this.preloadEntries();setTimeout(BX.delegate(function(){BX.addClass(this.gridMonthContainer,"calendar-change-month-previous");setTimeout(BX.delegate(function(){BX.removeClass(this.gridMonthContainer,"calendar-change-month-previous");BX.removeClass(e,"calendar-grid-month-previous");BX.addClass(e,"calendar-grid-month-current");BX.remove(this.grid);this.grid=e;BX.removeClass(this.grid,this.animateClass);this.displayEntries()},this),400)},this),0)};a.prototype.getViewRange=function(){var e=this.calendar.getViewRangeDate(),t=new Date(e.getTime());t.setMonth(e.getMonth()+1);return{start:e,end:t}};a.prototype.changeViewRangeDate=function(e){var t=this.calendar.getViewRangeDate(),i=new Date(t.getTime());i.setMonth(i.getMonth()+e);this.calendar.setViewRangeDate(i);return i};a.prototype.adjustViewRangeToDate=function(e){var t=this.calendar.getViewRangeDate(),i=false;var s=e.getMonth()-t.getMonth();if(s==1){this.increaseViewRangeDate()}else if(s==-1){this.decreaseViewRangeDate()}else{if(e&&e.getTime){i=new Date(e.getTime());i.setDate(1);i.setHours(0,0,0,0);this.calendar.setViewRangeDate(i)}this.fadeAnimation(this.getContainer(),100,BX.delegate(function(){this.show();this.getContainer().style.opacity=0;this.showAnimation(this.getContainer(),300)},this))}return i};a.prototype.getAdjustedDate=function(e,t){if(!e){e=new Date}if(e.getTime()<t.start.getTime()){e=new Date(t.start.getTime())}if(e.getTime()>t.end.getTime()){e=new Date(t.end.getTime())}var i=this.calendar.getViewRangeDate(),s=false;if(e&&e.getTime){s=new Date(e.getTime());s.setDate(1);s.setHours(0,0,0,0)}return s};a.prototype.buildDaysTitle=function(){BX.cleanNode(this.titleCont);var e,t,i=this.util.getWeekDays();for(e=0;e<i.length;e++){t=i[e];this.titleCont.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month-cell"},html:'<span class="calendar-grid-cell-inner">'+BX.message("EC_MONTH_WEEK_TITLE").replace("#DAY_OF_WEEK#",t[1])+"</span>"}))}};a.prototype.buildDaysGrid=function(e){if(!e)e={};var t,i,s=e.grid||this.grid,a=this.calendar.getViewRangeDate(),r=a.getFullYear(),n=a.getMonth(),o=this.util.getViewHeight(),l=BX.clone(this.getViewRange(),true),d=new Date;BX.cleanNode(s);d.setFullYear(r,n,1);this.dayIndex={};this.days=[];this.entryHolders=[];this.currentMonthRow=false;this.monthRows=[];if(this.util.getWeekStart()!=this.util.getWeekDayByInd(d.getDay())){i=this.util.getWeekDayOffset(this.util.getWeekDayByInd(d.getDay()));d.setDate(d.getDate()-i);l.start=new Date(d.getTime());l.start.setHours(0,0,0,0);for(t=0;t<i;t++){this.buildDayCell({date:d,month:"previous",grid:s});d.setDate(d.getDate()+1)}}d.setFullYear(r,n,1);while(d.getMonth()==n){this.buildDayCell({date:d,grid:s});d.setDate(d.getDate()+1)}if(this.util.getWeekStart()!=this.util.getWeekDayByInd(d.getDay())){i=this.util.getWeekDayOffset(this.util.getWeekDayByInd(d.getDay()));d.setFullYear(r,n+1,1);for(t=i;t<7;t++){this.buildDayCell({date:d,month:"next",grid:s});d.setDate(d.getDate()+1)}l.end=new Date(d.getTime());l.end.setHours(23,59,59,59)}this.calendar.setDisplayedViewRange(l);if(this.monthRows.length>0){this.rowHeight=Math.round(o/this.monthRows.length);this.slotsCount=Math.floor((this.rowHeight-this.eventHolderTopOffset)/this.slotHeight);for(t=0;t<this.monthRows.length;t++){this.monthRows[t].style.height=this.rowHeight+"px"}}};a.prototype.buildDayCell=function(e){var t=e.date,i="",s=Math.round(t.getTime()/1e3)*1e3,a=t.getDay(),r=this.util.getDayCode(t),n=this.util.getWeekDayByInd(a),o=false,l=this.util.getWeekStart()==n;if(l){this.currentMonthRow=e.grid.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month-row"}}));this.monthRows.push(this.currentMonthRow);if(this.util.showWeekNumber()){o=this.util.getWeekNumber(s)}}if(e.month=="previous"){i+=" calendar-grid-previous-month-day"}else if(e.month=="next"){i+=" calendar-grid-next-month-day"}if(this.util.isHoliday(t)){i+=" calendar-grid-holiday"}if(this.util.isToday(t)){i+=" calendar-grid-today"}this.days.push({date:new Date(t.getTime()),dayOffset:this.util.getWeekDayOffset(n),rowIndex:this.monthRows.length-1,holderIndex:this.entryHolders.length,node:this.currentMonthRow.appendChild(BX.create("DIV",{props:{className:BX.util.trim("calendar-grid-month-cell"+i)},attrs:{"data-bx-calendar-month-day":r},html:'<span class="calendar-grid-cell-inner">'+'<span class="calendar-num-day" data-bx-calendar-date="'+s+'">'+(t.getDate()==1?BX.message("EC_MONTH_SHORT").replace("#MONTH#",BX.date.format("M",s/1e3)).replace("#DATE#",t.getDate()):t.getDate())+"</span>"+(o?'<span class="calendar-num-week"  data-bx-cal-time="'+s+'" data-bx-calendar-weeknumber="'+o+'">'+o+"</span>":"")+"</span>"})),dayCode:r});this.dayIndex[this.days[this.days.length-1].dayCode]=this.days.length-1;this.calendar.dragDrop.registerDay(this.days[this.days.length-1]);if(this.currentMonthRow&&this.util.getWeekEnd()==n){this.entryHolders.push(this.currentMonthRow.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month-events-holder"}})))}};a.prototype.setTitle=function(){var e=this.calendar.getViewRangeDate();t.prototype.setTitle.apply(this,[BX.date.format("f",e.getTime()/1e3)+", #GRAY_START#"+e.getFullYear()+"#GRAY_END#"])};a.prototype.displayEntries=function(e){var t,i,s,a,r,n,o,l,d,h=[],p,c,f=this.calendar.getDisplayedViewRange();if(!e)e={};if(e.reloadEntries!==false){this.entries=this.entryController.getList({startDate:new Date(f.start.getFullYear(),f.start.getMonth(),1),finishDate:new Date(f.end.getFullYear(),f.end.getMonth()+1,1),viewRange:f,finishCallback:BX.proxy(this.displayEntries,this)})}this.entryHolders.forEach(function(e){BX.cleanNode(e)});this.days.forEach(function(e){e.slots=[];e.entries={list:[],started:[],hidden:[]}});if(this.entries===false||!this.entries||!this.entries.length)return;for(i=0;i<this.entries.length;i++){a=this.entries[i];this.entriesIndex[a.uid]=i;a.cleanParts();d=false;for(n=this.dayIndex[a.startDayCode];n<this.days.length;n++){l=this.days[n];if(l.dayCode==a.startDayCode||d&&l.dayOffset==0){d=true;r=a.startPart({from:l,daysCount:0});l.entries.started.push({entry:a,part:r})}if(d){l.entries.list.push({entry:a,part:r});r.daysCount++;r.to=l;if(l.dayCode==a.endDayCode||l.dayOffset==this.dayCount-1){h.push({part:r,entry:a});if(l.dayCode==a.endDayCode){break}}}}}for(i=0;i<h.length;i++){this.displayEntryPiece(h[i])}for(n=0;n<this.days.length;n++){l=this.days[n];if(l.entries.started.length>0){if(l.entries.started.length>0)l.entries.started.sort(this.calendar.entryController.sort);for(i=0;i<l.entries.started.length;i++){element=l.entries.started[i];if(element){a=element.entry;o=element.part;p=false;for(s=0;s<this.slotsCount;s++){if(l.slots[s]!==false){this.occupySlot({slotIndex:s,startIndex:n,endIndex:n+o.daysCount});p=true;a.getWrap(o.partIndex).style.top=s*this.slotHeight+"px";break}}if(!p){t=l.entries.started[i-1];if(t){l.entries.hidden.push(t);t.entry.getWrap(t.part.partIndex).style.display="none"}l.entries.hidden.push(element);a.getWrap(o.partIndex).style.display="none"}}}}if(l.entries.list.length>0){c=false;for(i=0;i<l.entries.list.length;i++){if(l.entries.list[i].part.params.wrapNode.style.display=="none"){c=true;break}}if(c){l.hiddenStorage=this.entryHolders[l.holderIndex].appendChild(BX.create("DIV",{props:{className:"calendar-event-line-wrap calendar-event-more-btn-container"},attrs:{"data-bx-calendar-show-all-events":l.dayCode},style:{top:this.rowHeight-42+"px",left:"calc((100% / "+this.dayCount+") * ("+(l.dayOffset+1)+" - 1) + 2px)",width:"calc(100% / "+this.dayCount+" - 3px)"}}));l.hiddenStorageText=l.hiddenStorage.appendChild(BX.create("span",{props:{className:"calendar-event-more-btn"}}));l.hiddenStorage.style.display="block";l.hiddenStorageText.innerHTML=BX.message("EC_SHOW_ALL")+" "+l.entries.list.length}else if(l.hiddenStorage){l.hiddenStorage.style.display="none"}}}BX.addClass(this.gridMonthContainer,"calendar-events-holder-show")};a.prototype.displayEntryPiece=function(e){var t=false,i=e.entry,s=e.part.from,a=e.part.daysCount,r,n,o,l,d,h,p,c="calendar-event-line-wrap",f=0,u,m,y=e.holder||this.entryHolders[s.holderIndex];if(y){if(i.isFullDay()){c+=" calendar-event-line-fill"}else if(i.isLongWithTime()){c+=" calendar-event-line-border"}if(i.isExternal()){c+=" calendar-event-line-intranet"}if(!e.popupMode&&this.util.getDayCode(i.from)!==this.util.getDayCode(s.date)){c+=" calendar-event-line-start-yesterday";f+=8;u=this.getArrow("left",i.color,i.isFullDay())}if(!e.popupMode&&this.util.getDayCode(i.to)!==this.util.getDayCode(e.part.to.date)){c+=" calendar-event-line-finish-tomorrow";m=this.getArrow("right",i.color,i.isFullDay());f+=12}if(u&&!m){f+=4}if(f==0){f=5}r=BX.create("DIV",{attrs:{"data-bx-calendar-entry":i.uid},props:{className:c},style:{top:0,left:"calc((100% / "+this.dayCount+") * ("+(s.dayOffset+1)+" - 1) + 2px)",width:"calc("+a+" * 100% / "+this.dayCount+" - "+f+"px)"}});if(u){r.appendChild(u);r.style.left="9px"}if(m){r.appendChild(m)}p=r.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner-container"}}));o=p.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner"}}));n=o.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-dot"}}));if(i.isFullDay()){o.style.maxWidth="calc(200% / "+a+" - 3px)"}else if(i.isLongWithTime()){r.style.borderColor=i.color;o.style.maxWidth="calc(200% / "+a+" - 3px)";if(e.part.partIndex==0){d=o.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(i.from.getHours(),i.from.getMinutes())}));o.style.width="calc(100% / "+a+" - 3px)"}if(e.part.partIndex==i.parts.length-1){if(a>1&&i.parts.length>1){o.style.width="calc("+(a-1)+"00% / "+a+" - 3px)"}if(!e.popupMode){h=o.appendChild(BX.create("SPAN",{props:{className:i.parts.length>1&&a==1?"calendar-event-line-time":"calendar-event-line-expired-time"},text:this.calendar.util.formatTime(i.to.getHours(),i.to.getMinutes())}))}}}else{d=o.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(i.from.getHours(),i.from.getMinutes())}))}l=o.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-text"},text:e.entry.name}));if(i.isFullDay()){p.style.backgroundColor=this.calendar.util.hexToRgba(i.color,.3);p.style.borderColor=this.calendar.util.hexToRgba(i.color,.3)}else{if(i.isLongWithTime()){p.style.borderColor=this.calendar.util.hexToRgba(i.color,.5)}n.style.backgroundColor=i.color}y.appendChild(r);if(i.opacity!==undefined){r.style.opacity=i.opacity}t={wrapNode:r,nameNode:l,innerContainer:p,innerNode:o,timeNode:d||false,endTimeNode:h||false,dotNode:n};if(!e.popupMode){e.entry.registerPartNode(e.part,t)}this.calendar.dragDrop.registerEntry(r,e)}return t};a.prototype.refreshEventsOnWeek=function(e){var t=e*7,i=(e+1)*7,s,a,r,n,o,l,d,h,p=[],c=5,f=0;for(o=0;o<c;o++)p[o]=0;for(a=t;a<i;a++){s=this.activeDateObjDays[a];if(!s)continue;s.arEvents.hidden=[];n=s.arEvents.begining;h=[];if(n.length>0){n.sort(function(e,t){if(t.daysCount==e.daysCount&&e.daysCount==1)return e.oEvent.DT_FROM_TS-t.oEvent.DT_FROM_TS;return t.daysCount-e.daysCount});e:for(r=0;r<n.length;r++){l=n[r];if(!l)continue;if(!this.arEvents[l.oEvent.ind]){s.arEvents.begining=n=BX.util.deleteFromArray(n,r);l=n[r];if(!l)continue}for(o=0;o<this.maxEventCount;o++){if(p[o]-f<=0){p[o]=f+l.daysCount;this.ShowEventOnLevel(l.oEvent.oParts[l.partInd],o,e);continue e}}h[l.oEvent.ID]=true;s.arEvents.hidden.push(l)}}d=s.arEvents.all;for(var u=0;u<d.length;u++){l=d[u];if(!l||h[l.oEvent.ID]){continue}if(!this.arEvents[l.oEvent.ind]){s.arEvents.all=d=BX.util.deleteFromArray(d,u);l=d[u];if(!l){continue}}if(l.oEvent.oParts&&l.partInd!=undefined&&l.oEvent.oParts[l.partInd]&&l.oEvent.oParts[l.partInd].style.display=="none"){s.arEvents.hidden.push(l)}}f++}};a.prototype.handleClick=function(e){if(this.isActive()){if(!e)e={};var t,i;if(e.specialTarget&&(i=e.specialTarget.getAttribute("data-bx-calendar-entry"))){this.handleEntryClick({uid:i,specialTarget:e.specialTarget,target:e.target,e:e.e})}else if(e.specialTarget&&(t=e.specialTarget.getAttribute("data-bx-calendar-show-all-events"))){this.deselectEntry();if(this.dayIndex[t]!==undefined&&this.days[this.dayIndex[t]]){this.showAllEventsInPopup({day:this.days[this.dayIndex[t]]})}}else if(!this.calendar.util.readOnlyMode()&&this.entryController.canDo(false,"add_event")&&(t=e.specialTarget&&e.specialTarget.getAttribute("data-bx-calendar-month-day"))){this.deselectEntry();if(this.dayIndex[t]!==undefined&&this.days[this.dayIndex[t]]){this.showNewEntryWrap({dayFrom:this.days[this.dayIndex[t]]})}}}};a.prototype.showNewEntryWrap=function(e){var t,i,s,a,r,n="calendar-event-line-wrap",o=0,l=e.dayFrom,d=1,h=this.entryHolders[l.holderIndex],p=this.calendar.sectionController.getCurrentSection(),c=p.color;t=this.entryController.getTimeForNewEntry(l.date);i=this.entryController.getDefaultEntryName();s=BX.create("DIV",{props:{className:n},style:{opacity:0,top:0,left:"calc((100% / "+this.dayCount+") * ("+(l.dayOffset+1)+" - 1) + 2px)",width:"calc("+d+" * 100% / "+this.dayCount+" - "+o+"px)"}});r=s.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner-container"}}));a=r.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner"}}));a.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},style:{color:"#fff"},text:this.calendar.util.formatTime(t.from.getHours(),t.from.getMinutes())}));a.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-text"},style:{color:"#fff"},text:i}));s.style.backgroundColor=c;s.style.borderColor=c;h.appendChild(s);var f=BX.pos(s);var u=BX.adjust(document.body.appendChild(s.cloneNode(true)),{props:{className:"calendar-event-line-clone"},style:{width:f.width-6+"px",height:f.height+"px",top:f.top+"px",left:f.left+1+"px"}});BX.addClass(h,"shifted");h.style.height=(this.slotsCount-1)*this.slotHeight+"px";setTimeout(function(){u.style.opacity="1"},100);setTimeout(BX.delegate(function(){this.showSimplePopup({entryTime:t,entryName:i,nameNode:u.querySelector(".calendar-event-line-text"),timeNode:u.querySelector(".calendar-event-line-time"),entryNode:u,section:p,closeCallback:function(){BX.cleanNode(u,true);BX.cleanNode(s,true);BX.removeClass(h,"shifted");h.style.height="1px"},changeDateCallback:BX.delegate(function(e){var t=this.util.getDayCode(e);if(t&&this.dayIndex[t]!==undefined&&this.days[this.dayIndex[t]]){var i=this.days[this.dayIndex[t]];s.style.left="calc((100% / "+this.dayCount+") * ("+(i.dayOffset+1)+" - 1) + 2px)";this.entryHolders[i.holderIndex].appendChild(s);var a=BX.pos(s);BX.adjust(u,{style:{width:a.width+1+"px",height:a.height+"px",top:a.top+"px",left:a.left+"px"}})}},this),saveCallback:function(){},changeSectionCallback:function(e){var t=e.color;if(u){u.style.background=t;u.style.borderColor=t}},fullFormCallback:BX.delegate(this.showEditSlider,this)})},this),200)};function r(e){t.apply(this,arguments);this.name="year";this.title=BX.message("EC_VIEW_YEAR");this.contClassName="calendar-year-view";this.build()}r.prototype=Object.create(t.prototype);r.prototype.constructor=r;function n(){t.apply(this,arguments);this.name="list";this.filterMode=false;this.title=BX.message("EC_VIEW_LIST");this.contClassName="calendar-list-view";this.loadDaysBefore=30;this.animateAmount=5;this.loadLimitPrevious=5;this.loadLimit=15;this.loadDaysAfter=60;this.SCROLL_DELTA_HEIGHT=200;this.todayCode=this.calendar.util.getDayCode(new Date);this.preBuild()}n.prototype=Object.create(t.prototype);n.prototype.constructor=n;n.prototype.preBuild=function(){this.viewCont=BX.create("DIV",{props:{className:this.contClassName},style:{display:"none"}});BX.addCustomEvent(this.calendar,"afterSetView",BX.delegate(function(e){if(e.viewName!==this.name&&this.filterMode){this.resetFilterMode()}},this))};n.prototype.build=function(){this.titleCont=this.viewCont.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month-row-days-week"}}));this.streamScrollWrap=this.viewCont.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-stream-container calendar-custom-scroll"},style:{height:this.util.getViewHeight()+"px"},events:{scroll:BX.proxy(this.scrollHandle,this)}}));this.streamContentWrap=this.streamScrollWrap.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-stream-container-content"}}));this.topLoaderBlock=this.streamContentWrap.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-loader-block"}}));this.listWrap=this.streamContentWrap.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-stream-container-list"}}));this.bottomLoaderBlock=this.streamContentWrap.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-loader-block"}}))};n.prototype.setTitle=function(){var e=this.calendar.getViewRangeDate();t.prototype.setTitle.apply(this,[BX.date.format("f",e.getTime()/1e3)+", #GRAY_START#"+e.getFullYear()+"#GRAY_END#"])};n.prototype.show=function(e){if(!e)e={};t.prototype.show.apply(this,arguments);this.showNavigationCalendar();BX.remove(this.calendar.additionalInfoOuter);var i=parseInt(this.calendar.util.config.init_year),s=parseInt(this.calendar.util.config.init_month);this.displayedRange={start:new Date(i,s-2,1),end:new Date(i,s+2,0)};this.calendar.setDisplayedViewRange(this.displayedRange);if(e.displayEntries!==false){this.displayEntries()}this.nothingToLoadNext=false;this.nothingToLoadPrevious=false};n.prototype.displayEntries=function(e){if(!e)e={};if(e.reloadEntries!==false){this.entries=this.entryController.getList({startDate:this.displayedRange.start,finishDate:this.displayedRange.end,viewRange:this.displayedRange,finishCallback:BX.proxy(this.displayEntries,this)})}BX.cleanNode(this.listWrap);this.dateGroupIndex={};this.groups=[];this.groupsDayCodes=[];this.groupsIndex={};this.entryListIndex={};if(this.entries===false||!this.entries||!this.entries.length){this.showEmptyBlock();return}if(this.noEntriesWrap){this.noEntriesWrap.style.display="none"}this.streamContentWrap.style.display="";this.entryParts=[];this.attachEntries(this.entries,false,BX.delegate(this.focusOnDate,this));setTimeout(BX.delegate(this.focusOnDate,this),100)};n.prototype.displayResult=function(e){this.streamContentWrap.style.display="";if(this.filterLoaderWrap){this.filterLoaderWrap.style.display="none"}BX.addClass(this.streamContentWrap,"calendar-timeline-stream-search-result");BX.cleanNode(this.listWrap);this.dateGroupIndex={};this.groups=[];this.groupsDayCodes=[];this.groupsIndex={};this.entryListIndex={};this.resultEntries=e;this.resultEntriesIndex={};e.forEach(function(e,t){this.resultEntriesIndex[e.uid]=t},this);if(e===false||!e||!e.length){this.showEmptyBlock();return}if(this.noEntriesWrap){this.noEntriesWrap.style.display="none"}this.streamContentWrap.style.display="";this.entryParts=[];this.attachEntries(e,"next")};n.prototype.attachEntries=function(e,t,i){if(!e&&!e.length)return;var s=this.entries.length-e.length,a=s,r,n,o,l;e.forEach(function(e){e.globalIndex=a++;o=this.calendar.util.getDayCode(e.from);l=this.calendar.util.getDayCode(e.to);n=0;this.entryParts.push({index:n,dayCode:o,from:e.from,entry:e});if(o!=l){r=new Date(e.from.getTime()+this.calendar.util.dayLength);while(r.getTime()<e.to.getTime()){this.entryParts.push({index:++n,dayCode:this.calendar.util.getDayCode(r),from:r,entry:e});r=new Date(r.getTime()+this.calendar.util.dayLength)}e.lastPartIndex=n}},this);var d=false;this.entryParts.sort(function(e,t){if(e.dayCode==t.dayCode){if(e.entry.isTask()!==t.entry.isTask()){if(e.entry.isTask())return 1;if(t.entry.isTask())return-1}if(e.entry.isFullDay()!==t.entry.isFullDay()){if(e.entry.isFullDay())return-1;if(t.entry.isFullDay())return 1}}if(e.index>0||t.index>0){return!d?e.index-t.index:t.index-e.index}return!d?e.entry.from.getTime()-t.entry.from.getTime():t.entry.from.getTime()-e.entry.from.getTime()});this.today=new Date;this.animationMode=t;this.currentDisplayedEntry=0;this.actuallyAnimatedEntryCount=0;this.displayEntry(this.entryParts[this.currentDisplayedEntry],t,i)};n.prototype.displayEntry=function(e,t,i){var s;if(e.from.getTime()>this.today.getTime()&&!this.groups[this.groupsIndex[this.todayCode]]&&!this.filterMode){this.createEntryGroupForDate(this.today,t)}s=this.groups[this.groupsIndex[e.dayCode]];if(!s){this.createEntryGroupForDate(e.from,t);s=this.groups[this.groupsIndex[e.dayCode]]}if(s.emptyWarning){BX.remove(s.emptyWarning)}var a=this.getUniqueId(e);if(this.actuallyAnimatedEntryCount>this.animateAmount){t=false;this.animationMode=false}var r=!this.entryListIndex[a];if(r){this.entryListIndex[a]=true;var n,o,l,d=e.entry;this.entriesIndex[d.uid]=d.globalIndex;if(d.isFullDay()){n=BX.message("EC_ALL_DAY")}else if(d.isLongWithTime()){if(e.index===0)n=this.calendar.util.formatTime(d.from);else if(e.index===d.lastPartIndex)n=BX.message("EC_TILL_TIME").replace("#TIME#",this.calendar.util.formatTime(d.to));else n=BX.message("EC_ALL_DAY")}else{n=this.calendar.util.formatTime(d.from.getHours(),d.from.getMinutes())+" &ndash; "+this.calendar.util.formatTime(d.to.getHours(),d.to.getMinutes())}o=s.content.appendChild(BX.create("DIV",{attrs:{"data-bx-calendar-entry":d.uid},props:{className:"calendar-timeline-stream-content-event"+(t?" calendar-timeline-stream-section-event-animate-"+t:"")}}));o.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-stream-content-event-time"},html:'<span class="calendar-timeline-stream-content-event-time-link">'+n+"</span>"}));var h=this.calendar.util.getTextLocation(d.location)||"";if(h){h='<span class="calendar-timeline-stream-content-event-location">('+BX.util.htmlspecialchars(h)+")</span>"}o.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-stream-content-event-name"},html:'<span class="calendar-timeline-stream-content-event-color" style="background-color: '+d.color+'"></span><span class="calendar-timeline-stream-content-event-name-link">'+BX.util.htmlspecialchars(d.name)+"</span>"+h}));l=o.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-stream-content-event-members"}}));if(d.isMeeting()&&d.getAttendees().length>0){this.showAttendees(l,d.getAttendees().filter(function(e){return e.STATUS=="Y"||e.STATUS=="H"}),d.getAttendees().length)}else if(d.isPersonal()){l.innerHTML=BX.message("EC_EVENT_IS_MINE")}e.DOM={};if(e.dayCode==this.todayCode&&BX.type.isFunction(i)){i()}}if(this.currentDisplayedEntry<this.entryParts.length-1){this.currentDisplayedEntry++;if(t&&r){this.actuallyAnimatedEntryCount++;setTimeout(BX.delegate(function(){this.displayEntry(this.entryParts[this.currentDisplayedEntry],t,i)},this),300)}else{if(this.currentDisplayedEntry%30==0){setTimeout(BX.delegate(function(){this.displayEntry(this.entryParts[this.currentDisplayedEntry],t,i)},this),1e3)}else{this.displayEntry(this.entryParts[this.currentDisplayedEntry],t,i)}}}else if(this.currentDisplayedEntry==this.entryParts.length-1&&!this.filterMode){this.animationMode=false;if(!this.groups[this.groupsIndex[this.todayCode]]){this.createEntryGroupForDate(this.today,t)}this.groupsDayCodes.sort();if(BX.type.isFunction(i)){i()}}};n.prototype.showAttendees=function(e,t,i){var s,a,r=5,n=t.length,o=7;if(n>0){if(n>o){n=r}for(s=0;s<n;s++){a=t[s]||{};e.appendChild(BX.create("IMG",{attrs:{id:"simple_view_popup_"+a.ID,src:a.AVATAR||""},props:{title:a.DISPLAY_NAME,className:"calendar-member"}}));(function(e){setTimeout(function(){BX.tooltip(e,"simple_view_popup_"+e)},100)})(a.ID)}if(n<t.length){var l=e.appendChild(BX.create("SPAN",{props:{className:"calendar-member-more-count"},text:" "+BX.message("EC_ATTENDEES_MORE").replace("#COUNT#",t.length-n),events:{click:BX.delegate(function(){this.showUserListPopup(l,t)},this)}}))}}};n.prototype.showUserListPopup=function(e,t){if(this.userListPopup)this.userListPopup.close();this.popup.setAutoHide(false);if(!t||!t.length)return;this.DOM.userListPopupWrap=BX.create("DIV",{props:{className:"calendar-user-list-popup-block"}});t.forEach(function(e){var t=this.DOM.userListPopupWrap.appendChild(BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-container calendar-slider-sidebar-user-card"}}));t.appendChild(BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-block-avatar"}})).appendChild(BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-block-item"}})).appendChild(BX.create("IMG",{props:{width:34,height:34,src:e.AVATAR}}));t.appendChild(BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-info"}})).appendChild(BX.create("A",{props:{href:e.URL?e.URL:"#",className:"calendar-slider-sidebar-user-info-name"},text:e.DISPLAY_NAME}))},this);this.userListPopup=new BX.PopupWindow(this.calendar.id+"-view-user-list-popup",e,{autoHide:true,closeByEsc:true,offsetTop:0,offsetLeft:0,width:200,resizable:false,lightShadow:true,content:this.DOM.userListPopupWrap,className:"calendar-user-list-popup",zIndex:4e3});this.userListPopup.setAngle({offset:36});this.userListPopup.show();BX.addCustomEvent(this.userListPopup,"onPopupClose",BX.delegate(function(){this.popup.setAutoHide(true);this.userListPopup.destroy()},this))};n.prototype.appendDateGroup=function(e,t,i){var s,a,r,n,o,l,d=t.getDate(),h=t.getMonth()+1,p=t.getFullYear();if(!this.dateGroupIndex[p]){n=Infinity;o=p;for(s in this.dateGroupIndex){if(this.dateGroupIndex.hasOwnProperty(s)){if(Math.abs(p-s)<n){n=Math.abs(p-s);o=s}if(n==1){break}}}this.dateGroupIndex[p]={node:BX.create("DIV",{attrs:{"data-bx-calendar-list-year":p}}),monthIndex:{}};if(o==p){this.listWrap.appendChild(this.dateGroupIndex[p].node)}else{if(p-o>0){if(this.dateGroupIndex[o].node.nextSibling){BX.insertAfter(this.dateGroupIndex[p].node,this.dateGroupIndex[o].node)}else{this.listWrap.appendChild(this.dateGroupIndex[p].node)}}else{this.listWrap.insertBefore(this.dateGroupIndex[p].node,this.dateGroupIndex[o].node)}}}if(!this.dateGroupIndex[p].monthIndex[h]){n=Infinity;o=h;for(a in this.dateGroupIndex[p].monthIndex){if(this.dateGroupIndex[p].monthIndex.hasOwnProperty(a)){if(Math.abs(h-a)<n){n=Math.abs(h-a);o=a}if(n==1){break}}}this.dateGroupIndex[p].monthIndex[h]={node:BX.create("DIV",{attrs:{"data-bx-calendar-list-month":h}}),dayIndex:{}};if(o==h){this.dateGroupIndex[p].node.appendChild(this.dateGroupIndex[p].monthIndex[h].node)}else{if(h-o>0){if(this.dateGroupIndex[p].monthIndex[o].node.nextSibling){BX.insertAfter(this.dateGroupIndex[p].monthIndex[h].node,this.dateGroupIndex[p].monthIndex[o].node)}else{this.dateGroupIndex[p].node.appendChild(this.dateGroupIndex[p].monthIndex[h].node)}}else{this.dateGroupIndex[p].monthIndex[o].node.parentNode.insertBefore(this.dateGroupIndex[p].monthIndex[h].node,this.dateGroupIndex[p].monthIndex[o].node)}}}if(!this.dateGroupIndex[p].monthIndex[h].dayIndex[d]){n=Infinity;o=d;l=this.dateGroupIndex[p].monthIndex;for(r in l[h].dayIndex){if(l[h].dayIndex.hasOwnProperty(r)){if(Math.abs(d-r)<n){n=Math.abs(d-r);o=r}if(n==1){break}}}l[h].dayIndex[d]={node:BX.create("DIV",{props:{className:"calendar-timeline-stream-day"},attrs:{"data-bx-calendar-list-day":d}})};if(o==d){l[h].node.appendChild(l[h].dayIndex[d].node)}else{if(d-o>0){if(l[h].dayIndex[o].node.nextSibling){BX.insertAfter(l[h].dayIndex[d].node,l[h].dayIndex[o].node)}else{l[h].node.appendChild(l[h].dayIndex[d].node)}}else{l[h].node.insertBefore(l[h].dayIndex[d].node,l[h].dayIndex[o].node)}}}if(l[h].dayIndex[d].node){l[h].dayIndex[d].node.appendChild(e)}else{}setTimeout(function(){e.style.opacity="1"},0)};n.prototype.hide=function(){t.prototype.hide.apply(this,arguments)};n.prototype.getAdjustedDate=function(e,t){if(!e){e=new Date}var i=this.calendar.getViewRangeDate(),s=false;if(e&&e.getTime){s=new Date(e.getTime())}return s};n.prototype.adjustViewRangeToDate=function(e,t){if(this.viewCont.style.display=="none"){var i=false;if(e&&e.getTime){i=new Date(e.getTime());i.setHours(0,0,0,0);this.currentDate=i;this.calendar.setViewRangeDate(i)}if(t!==false){this.fadeAnimation(this.getContainer(),100,BX.delegate(function(){this.show();this.getContainer().style.opacity=0;this.showAnimation(this.getContainer(),300)},this))}else{this.show()}}else{var s=this.calendar.util.getDayCode(e);var a=BX.util.array_search(s,this.groupsDayCodes);if(a>=0&&this.groupsDayCodes[a]){this.focusOnDate(this.groupsDayCodes[a],true)}}return i};n.prototype.getViewRange=function(){var e=this.calendar.getViewRangeDate(),t=new Date(e.getTime());return{start:e,end:t}};n.prototype.increaseViewRangeDate=function(){var e=BX.util.array_search(this.focusedDayCode,this.groupsDayCodes);if(e>=0&&this.groupsDayCodes[e+1]){this.focusOnDate(this.groupsDayCodes[e+1],true)}};n.prototype.decreaseViewRangeDate=function(){var e=BX.util.array_search(this.focusedDayCode,this.groupsDayCodes);if(e>0&&this.groupsDayCodes[e-1]){this.focusOnDate(this.groupsDayCodes[e-1],true)}};n.prototype.createEntryGroupForDate=function(e,t){var i=this.calendar.util.getDayCode(e),s=Math.round(e.getTime()/1e3)*1e3,a={dayCode:i,wrap:BX.create("DIV",{props:{className:"calendar-timeline-stream-section-wrap"}})};a.titleNode=a.wrap.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-stream-section calendar-timeline-section-date-label"},html:'<div data-bx-calendar-date="'+s+'" class="calendar-timeline-stream-section-content"><div class="'+(i==this.todayCode?"calendar-timeline-stream-today-label":"calendar-timeline-stream-label")+'">'+this.calendar.util.formatDateUsable(e)+"</div></div>"}));a.groupNode=a.wrap.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-stream-section"}}));a.content=a.groupNode.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-stream-section-content"}}));a.emptyWarning=a.content.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-empty-section"},text:BX.message("EC_NO_EVENTS")}));this.groups.push(a);this.groupsIndex[i]=this.groups.length-1;this.groupsDayCodes.push(i);this.appendDateGroup(this.groups[this.groups.length-1].wrap,e,t)};n.prototype.focusOnDate=function(e,t){var i=false;if(BX.type.isDate(e))i=this.calendar.util.getDayCode(e);else if(BX.type.isString(e))i=e;else i=this.todayCode;this.focusedDayCode=i;if(this.groupsIndex&&this.groups[this.groupsIndex[i]]){this.bottomLoaderBlock.style.height=this.SCROLL_DELTA_HEIGHT+Math.max(0,this.util.getViewHeight()+this.groups[this.groupsIndex[i]].wrap.offsetTop-this.bottomLoaderBlock.offsetTop)+"px";if(t&&this.streamScrollWrap){new BX.easing({duration:300,start:{scrollTop:this.streamScrollWrap.scrollTop},finish:{scrollTop:this.groups[this.groupsIndex[i]].wrap.offsetTop},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:BX.delegate(function(e){this.streamScrollWrap.scrollTop=e.scrollTop},this),complete:BX.delegate(function(){this.streamScrollWrap.scrollTop=this.groups[this.groupsIndex[i]].wrap.offsetTop},this)}).animate()}else{setTimeout(BX.delegate(function(){if(this.streamScrollWrap&&this.groupsIndex[i]!==undefined&&this.groups[this.groupsIndex[i]]){this.streamScrollWrap.scrollTop=this.groups[this.groupsIndex[i]].wrap.offsetTop}},this),200)}}};n.prototype.scrollHandle=function(){if(!this.filterMode){if(this.streamScrollWrap.scrollHeight-this.util.getViewHeight()-this.streamScrollWrap.scrollTop<this.SCROLL_DELTA_HEIGHT&&!this.nothingToLoadNext){this.loadMoreEntries({mode:"next"})}else if(this.streamScrollWrap.scrollTop<this.SCROLL_DELTA_HEIGHT&&!this.nothingToLoadPrevious){this.loadMoreEntries({mode:"previous"})}}};n.prototype.loadMoreEntries=function(e){if(this.currentLoadMode||this.filterMode)return;this.currentLoadMode=e.mode;if(e.mode=="next"){this.loader=this.bottomLoaderBlock.appendChild(BX.adjust(this.calendar.util.getLoader(),{style:{height:"180px"}}));this.entryController.getList({loadNext:true,loadLimit:this.loadLimit,startDate:new Date(this.displayedRange.end.getFullYear(),this.displayedRange.end.getMonth(),this.displayedRange.end.getDate()+1),finishCallback:BX.proxy(this.loadMoreCallback,this)})}else{this.loader=this.topLoaderBlock.appendChild(BX.adjust(this.calendar.util.getLoader(),{style:{height:"180px"}}));this.entryController.getList({loadPrevious:true,loadLimit:this.loadLimitPrevious,finishDate:new Date(this.displayedRange.start.getFullYear(),this.displayedRange.start.getMonth(),this.displayedRange.start.getDate()-1),finishCallback:BX.proxy(this.loadMoreCallback,this)})}};n.prototype.loadMoreCallback=function(e){BX.remove(this.loader);this.displayedRange=this.calendar.entryController.getLoadedEntiesLimits();var t=this.entryController.getList({startDate:this.displayedRange.start,finishDate:this.displayedRange.end,finishCallback:BX.proxy(this.loadMoreCallback,this)});if(this.currentLoadMode=="next"&&e.finish)this.nothingToLoadNext=true;if(this.currentLoadMode=="previous"&&e.finish)this.nothingToLoadPrevious=true;if(!this.entries)this.entries=[];if(t&&t.length){this.entries=this.entries.concat(t);this.attachEntries(t,this.currentLoadMode=="next"?"next":false)}this.currentLoadMode=false};n.prototype.getUniqueId=function(e){return e.entry.uid+"|"+e.dayCode};n.prototype.handleClick=function(e){if(this.isActive()){if(!e)e={};var t,i;if(e.specialTarget&&(i=e.specialTarget.getAttribute("data-bx-calendar-entry"))){this.handleEntryClick({uid:i,specialTarget:e.specialTarget,target:e.target,e:e.e})}else if(e.specialTarget&&(t=e.specialTarget.getAttribute("data-bx-calendar-show-all-events"))){}else if(!this.calendar.util.readOnlyMode()&&this.entryController.canDo(true,"add_event")&&(t=e.specialTarget&&e.specialTarget.getAttribute("data-bx-calendar-week-day"))){this.deselectEntry();this.showSimplePopupForNewEntry({entry:this.buildTopNewEntryWrap({dayFrom:this.days[this.dayIndex[t]],holder:this.topEntryHolder})})}}};n.prototype.showEmptyBlock=function(t){if(!this.noEntriesWrap){this.noEntriesWrap=this.streamScrollWrap.appendChild(BX.create("DIV",{props:{className:"calendar-search-main"},style:{height:this.util.getViewHeight()+"px"}}));var i=this.noEntriesWrap.appendChild(BX.create("DIV",{props:{className:"calendar-search-empty"},html:'<div class="calendar-search-empty-name">'+BX.message("EC_NO_EVENTS")+"</div>"}));if(!this.calendar.util.readOnlyMode()){this.addButton=i.appendChild(BX.create("SPAN",{props:{className:"calendar-search-empty-link"},text:BX.message("EC_CREATE_EVENT"),events:{click:BX.proxy(function(){if(!this.calendar.editSlider){this.calendar.editSlider=new e.BXEventCalendar.EditEntrySlider(this.calendar)}this.calendar.editSlider.show({})},this)}}))}}this.streamContentWrap.style.display="none";this.noEntriesWrap.style.display=""};n.prototype.applyFilterMode=function(){this.filterMode=true;this.calendar.viewTitleContainer.style.display="none";this.calendar.navigationWrap.style.display="none";if(this.searchHead){BX.remove(this.searchHead)}this.searchHead=this.calendar.topBlock.appendChild(BX.create("DIV",{props:{className:"calendar-search-head"},html:'<div class="calendar-search-name">'+BX.message("EC_SEARCH_RESULT")+"</div>"}));if(this.resettFilterWrap){BX.remove(this.resettFilterWrap)}this.resettFilterWrap=this.searchHead.appendChild(BX.create("DIV",{props:{className:"calendar-search-cancel"},html:BX.message("EC_SEARCH_RESET_RESULT"),events:{click:BX.proxy(this.resetFilterMode,this)}}));if(this.streamScrollWrap){if(!this.filterLoaderWrap){this.filterLoaderWrap=this.streamScrollWrap.appendChild(BX.create("DIV",{props:{className:"calendar-search-main"},style:{height:this.util.getViewHeight()+"px"}}));var e=this.filterLoaderWrap.appendChild(BX.create("DIV",{props:{className:"calendar-search-empty"},html:'<div class="calendar-search-empty-name">'+BX.message("EC_NO_EVENTS")+"</div>"}))}this.streamContentWrap.style.display="none";this.filterLoaderWrap.style.display=""}};n.prototype.resetFilterMode=function(e){this.filterMode=false;this.resultEntries=[];this.calendar.viewTitleContainer.style.display="";this.calendar.navigationWrap.style.display="";this.setTitle();if(this.searchHead){BX.remove(this.searchHead)}if(this.resettFilterWrap){BX.remove(this.resettFilterWrap)}this.streamContentWrap.style.display="";if(this.filterLoaderWrap){this.filterLoaderWrap.style.display="none"}if(!e||e.resetSearchFilter!==false)this.calendar.search.resetFilter();if(this.isActive())this.displayEntries()};n.prototype.handleEntryClick=function(e){if(this.filterMode){if(this.resultEntriesIndex[e.uid]!==undefined){e.entry=this.resultEntries[this.resultEntriesIndex[e.uid]]}}t.prototype.handleEntryClick.apply(this,arguments)};if(e.BXEventCalendar){e.BXEventCalendar.CalendarView=t;e.BXEventCalendar.CalendarDayView=i;e.BXEventCalendar.CalendarWeekView=s;e.BXEventCalendar.CalendarMonthView=a;e.BXEventCalendar.CalendarYearView=r;e.BXEventCalendar.CalendarListView=n}else{BX.addCustomEvent(e,"onBXEventCalendarInit",function(){e.BXEventCalendar.CalendarView=t;e.BXEventCalendar.CalendarDayView=i;e.BXEventCalendar.CalendarWeekView=s;e.BXEventCalendar.CalendarMonthView=a;e.BXEventCalendar.CalendarYearView=r;e.BXEventCalendar.CalendarListView=n})}})(window);