(function(){"use strict";BX.namespace("BX.UI");BX.UI.ActionPanel=function(t){this.groupActions=t.groupActions;this.layout={container:null,itemContainer:null,more:null,reset:null,totalSelected:null,totalSelectedItem:null};this.itemContainer=null;this.renderContainer=t.renderTo;this.items=[];this.hiddenItems=[];this.grid=null;this.tileGrid=null;this.params=t.params||{};this.buildPanelContainer();this.bindEvents()};BX.UI.ActionPanel.prototype={bindEvents:function(){BX.addCustomEvent("Grid::ready",this.handleGridReady.bind(this));BX.addCustomEvent("BX.TileGrid.Grid::ready",this.handleTileGridReady.bind(this));BX.addCustomEvent(window,"BX.TileGrid.Grid:selectItem",this.handleTileSelectItem.bind(this));BX.addCustomEvent(window,"BX.TileGrid.Grid:checkItem",this.handleTileSelectItem.bind(this));BX.addCustomEvent(window,"BX.TileGrid.Grid:unSelectItem",this.handleTileUnSelectItem.bind(this));BX.addCustomEvent("Grid::thereSelectedRows",this.handleGridSelectItem.bind(this));BX.addCustomEvent("Grid::allRowsSelected",this.handleGridSelectItem.bind(this));BX.addCustomEvent(window,"BX.TileGrid.Grid:redraw",this.hidePanel.bind(this));BX.addCustomEvent(window,"BX.TileGrid.Grid:defineEscapeKey",this.hidePanel.bind(this));BX.addCustomEvent(window,"BX.TileGrid.Grid:lastSelectedItem",this.hidePanel.bind(this));BX.addCustomEvent(window,"BX.UI.ActionPanel:clickResetAllBlock",this.hidePanel.bind(this));BX.addCustomEvent(window,"BX.TileGrid.Grid:multiSelectModeOff",this.hidePanel.bind(this));BX.addCustomEvent("Grid::updated",this.hidePanel.bind(this));BX.addCustomEvent("Grid::noSelectedRows",this.hidePanel.bind(this));BX.addCustomEvent("Grid::allRowsUnselected",this.hidePanel.bind(this));BX.bind(window,"click",this.handleOuterClick.bind(this));BX.bind(window,"scroll",this.handleScroll.bind(this));BX.bind(window,"resize",BX.throttle(this.adjustPanelStyle,20,this))},addItems:function(t){t.forEach(function(t){this.appendItem(t)}.bind(this));this.items.forEach(function(t){if(!t.isVisible()&&!this.layout.more){this.appendMoreBlock()}},this);this.items.forEach(function(t){if(!t.isVisible()){this.addHiddenItem(t)}},this)},buildItem:function(t){t.actionPanel=this;return new BX.UI.ActionPanel.Item(t)},appendItem:function(t){var e=this.buildItem(t);this.items.push(e);this.layout.itemContainer.appendChild(e.render())},addHiddenItem:function(t){this.hiddenItems.push(t)},removeHiddenItem:function(t){for(var e=0;e<this.hiddenItems.length;e++){if(this.hiddenItems[e].id===t.id){delete this.hiddenItems[e];this.hiddenItems.splice(e,1);return}}},removeItems:function(){this.items.forEach(function(t){t.destroy()});this.items=[];this.hiddenItems=[]},appendMoreBlock:function(){this.layout.more=BX.create("div",{props:{className:"ui-action-panel-more"},text:BX.message("JS_UI_ACTIONPANEL_MORE_BLOCK"),events:{click:this.handleClickMoreBlock.bind(this)}});this.layout.container.appendChild(this.layout.more)},getResetAllBlock:function(){this.layout.reset=BX.create("div",{props:{className:"ui-action-panel-reset"}});BX.bind(this.layout.reset,"click",function(){BX.onCustomEvent("BX.UI.ActionPanel:clickResetAllBlock");this.resetAllSection()}.bind(this));return this.layout.reset},resetAllSection:function(){if(this.grid){this.grid.getRows().unselectAll()}else if(this.tileGrid){this.tileGrid.resetSetMultiSelectMode();this.tileGrid.resetSelectAllItems();this.tileGrid.resetFromToItems()}},handleScroll:function(){if(this.getDistanceFromTop()>0){this.unfixPanel()}else{this.fixPanel()}var t=BX.PopupMenu.getMenuById("ui-action-panel-item-popup-menu");if(t){t.popupWindow.adjustPosition()}},handleOuterClick:function(t){var e=BX.getEventTarget(t);if(BX.hasClass(e,"ui-action-panel")){return}if(BX.findParent(e,{className:"ui-action-panel"})){return}if(BX.findParent(e,{className:"main-grid-container"})){return}if(BX.findParent(e,{className:"ui-grid-tile-item"})){return}this.hidePanel();if(this.grid){this.resetAllSection()}},handleClickMoreBlock:function(t){var e=this.layout.more;var i=BX.PopupMenu.create("ui-action-panel-item-popup-menu",e,this.hiddenItems,{className:"ui-action-panel-item-popup-menu",angle:true,offsetLeft:e.offsetWidth/2,closeByEsc:true,events:{onPopupShow:function(){BX.bind(i.popupWindow.popupContainer,"click",function(t){var e=BX.getEventTarget(t);var n=BX.findParent(e,{className:"menu-popup-item"},10);if(!n||!n.dataset.preventCloseContextMenu){i.close()}})},onPopupClose:function(){i.destroy();BX.removeClass(e,"ui-action-panel-item-active")}}});i.layout.menuContainer.setAttribute("data-tile-grid","tile-grid-stop-close");i.show()},removeMoreBlock:function(){if(!this.layout.more)return;this.layout.more.parentNode.removeChild(this.layout.more);this.layout.more=null},getDistanceFromTop:function(){return this.renderContainer.getBoundingClientRect().top},fixPanel:function(){BX.addClass(this.layout.container,"ui-action-panel-fixed")},unfixPanel:function(){BX.removeClass(this.layout.container,"ui-action-panel-fixed")},buildPanelContainer:function(){this.layout.container=BX.create("div",{attrs:{className:"ui-action-panel"},dataset:{tileGrid:"tile-grid-stop-close"},children:[this.getTotalSelectedBlock(),this.getItemContainer(),this.getResetAllBlock()]})},getItemContainer:function(){return this.layout.itemContainer=BX.create("div",{props:{className:"ui-action-panel-wrapper"}})},getTotalSelectedBlock:function(){return this.layout.totalSelected=BX.create("div",{props:{className:"ui-action-panel-total"},children:[BX.create("span",{props:{className:"ui-action-panel-total-label"},text:BX.message("JS_UI_ACTIONPANEL_IS_SELECTED")}),this.layout.totalSelectedItem=BX.create("span",{props:{className:"ui-action-panel-total-param"}})]})},getPanelContainer:function(){return this.layout.container},adjustPanelStyle:function(){var t=BX.pos(this.renderContainer);this.layout.container.style.width=t.width+"px";this.layout.container.style.top=t.top+"px";this.layout.container.style.left=t.left+"px"},handleGridReady:function(t){if(!this.grid&&t.getContainerId()===this.params.gridId){this.grid=t}},handleTileGridReady:function(t){if(!this.tileGrid&&t.getId()===this.params.tileGridId){this.tileGrid=t}},handleGridUnSelectItem:function(t,e){if(e.getRows().getSelectedIds().length===1){this.buildPanelByItem(e.getRows().getSelected().pop())}},handleTileUnSelectItem:function(t,e){if(e.getSelectedItems().length===1){this.buildPanelByItem(e.getSelectedItems().pop())}this.setTotalSelectedItems(e.getSelectedItems().length)},handleGridSelectItem:function(){this.setTotalSelectedItems(this.grid.getRows().getSelectedIds().length);if(this.grid.getRows().getSelectedIds().length>1){this.buildPanelByGroup()}else{this.buildPanelByItem(this.grid.getRows().getSelected().pop())}},handleTileSelectItem:function(t,e){this.setTotalSelectedItems(e.getSelectedItems().length);if(e.isMultiSelectMode()&&e.getSelectedItems().length>1){this.buildPanelByGroup()}else{this.buildPanelByItem(t)}},buildPanelByItem:function(t){var e=t.getActions();var i=[];e.forEach(function(t){i.push(t)}.bind(this));this.removeItems();this.addItems(i);this.showPanel();if(this.hiddenItems.length<=0)this.removeMoreBlock()},buildPanelByGroup:function(){if(!this.groupActions){return}var t=this.extractButtonsFromGroupActions(this.groupActions);this.removeItems();this.addItems(t);this.showPanel()},setTotalSelectedItems:function(t){this.layout.totalSelectedItem.innerHTML=t},extractButtonsFromGroupActions:function(t){var e=BX.clone(t);if(!e["GROUPS"]||!e["GROUPS"][0]||!e["GROUPS"][0]["ITEMS"]){return[]}var i=[];var n=e["GROUPS"][0]["ITEMS"];n.forEach(function(t){if(t.TYPE==="BUTTON"){var e=t.ONCHANGE.pop();if(e&&e.ACTION==="CALLBACK"){var n=e.DATA.pop();i.push({id:t.ID||t.VALUE,text:t.TEXT||t.NAME,icon:t.ICON,onclick:n.JS})}}});return i},showPanel:function(){if(BX.hasClass(this.layout.container,"ui-action-panel-show"))return;BX.addClass(this.layout.container,"ui-action-panel-show");BX.addClass(this.layout.container,"ui-action-panel-show-animate");var t=BX.pos(this.renderContainer);this.layout.container.style.height=t.height+"px";setTimeout(function(){BX.removeClass(this.layout.container,"ui-action-panel-show-animate")}.bind(this),300)},hidePanel:function(){BX.removeClass(this.layout.container,"ui-action-panel-show");BX.removeClass(this.layout.container,"ui-action-panel-show-animate");BX.addClass(this.layout.container,"ui-action-panel-hide-animate");setTimeout(function(){BX.removeClass(this.layout.container,"ui-action-panel-hide-animate")}.bind(this),300)},draw:function(){document.body.appendChild(this.getPanelContainer());this.adjustPanelStyle()}}})();