(function(){"use strict";BX.namespace("BX.Landing");var e=BX.Landing.Utils.attr;BX.Landing.Block.Node.Img=function(e){BX.Landing.Block.Node.apply(this,arguments);this.editPanel=null;this.lastValue=null;this.field=null;this.uploadParams=e.uploadParams;if(!this.isGrouped()){this.node.addEventListener("click",this.onClick.bind(this))}if(this.isAllowInlineEdit()){this.node.setAttribute("title",BX.message("LANDING_TITLE_OF_IMAGE_NODE"))}};function t(e){return e.node.nodeName!=="IMG"}function n(e){return e.node.nodeName==="IMG"}function i(e){return e.node.nodeName==="SPAN"||e.node.nodeName==="I"||e.node.nodeName==="EM"}function a(e){var t=e.node.style.backgroundImage;t=!!t?t:"";return t.slice(4,-1).replace(/["|']/g,"")}function s(e){var t=parseInt(e.node.dataset.fileid);return t===t?t:-1}function d(t){var n=e(t.node,"alt");return!!n?n:""}function o(t){var n=e(t.node,"src");return!!n?n:""}function l(e,t){if(!n(e)){var i=BX.create("img",{attrs:{src:t.src,alt:t.alt,"data-fileid":t.id}});e.node.parentNode.insertBefore(i,e.node);BX.remove(e.node);e.node=i}else{e.node.src=t.src;e.node.alt=t.alt;e.node.dataset.fileid=t.id||-1}}function r(e,n){if(!t(e)){var i=BX.create("div",{attrs:{style:'background-image: url("'+n.src+'")',"data-fileid":n.id}});e.node.parentNode.insertBefore(i,e.node);BX.remove(e.node);e.node=i}else{e.node.style.backgroundImage='url("'+n.src+'")';e.node.dataset.fileid=n.id||-1}}BX.Landing.Block.Node.Img.prototype={__proto__:BX.Landing.Block.Node.prototype,constructor:BX.Landing.Block.Node.Img,onClick:function(e){if(this.manifest.allowInlineEdit!==false&&BX.Landing.Main.getInstance().isControlsEnabled()&&(!BX.Landing.Block.Node.Text.currentNode||!BX.Landing.Block.Node.Text.currentNode.isEditable())&&!BX.Landing.UI.Panel.StylePanel.getInstance().isShown()){e.preventDefault();e.stopPropagation();BX.Landing.UI.Button.FontAction.hideAll();BX.Landing.UI.Button.ColorAction.hideAll();if(!this.editPanel){this.editPanel=new BX.Landing.UI.Panel.Content(this.selector,{title:BX.message("LANDING_IMAGE_PANEL_TITLE"),className:"landing-ui-panel-edit-image"});this.editPanel.appendFooterButton(new BX.Landing.UI.Button.BaseButton("save_block_content",{text:BX.message("BLOCK_SAVE"),onClick:this.save.bind(this),className:"landing-ui-button-content-save"}));this.editPanel.appendFooterButton(new BX.Landing.UI.Button.BaseButton("cancel_block_content",{text:BX.message("BLOCK_CANCEL"),onClick:this.editPanel.hide.bind(this.editPanel),className:"landing-ui-button-content-cancel"}));document.body.appendChild(this.editPanel.layout)}var t=new BX.Landing.UI.Form.BaseForm({title:this.manifest.name});t.addField(this.getField());this.editPanel.clear();this.editPanel.appendForm(t);this.editPanel.show();BX.Landing.UI.Panel.EditorPanel.getInstance().hide();BX.Landing.UI.Panel.SmallEditorPanel.getInstance().hide()}},save:function(){var e=this.editPanel.forms[0].fields[0].getValue();if(JSON.stringify(this.getValue())!==JSON.stringify(e)){this.setValue(e)}this.editPanel.hide()},getField:function(){if(!this.field){var e="";if(this.manifest.dimensions){e=BX.message("LANDING_CONTENT_IMAGE_RECOMMENDED_SIZE")+" ";e+=this.manifest.dimensions.width+"px&nbsp;/&nbsp;";e+=this.manifest.dimensions.height+"px"}this.field=new BX.Landing.UI.Field.Image({selector:this.selector,title:this.manifest.name,description:e,content:this.getValue(),dimensions:!!this.manifest.dimensions?this.manifest.dimensions:{},disableAltField:t(this),uploadParams:this.uploadParams})}else{this.field.setValue(this.getValue());this.field.content=this.getValue();requestAnimationFrame(function(){this.field.adjustPreviewBackgroundSize()}.bind(this))}return this.field},setValue:function(e,i,a){this.lastValue=this.lastValue||this.getValue();this.preventSave(i);e.src=decodeURIComponent(e.src);if(n(this)){l(this,e)}if(t(this)){r(this,e)}this.onChange();if(!a){BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:top.BX.Landing.Block.storage.getByChildNode(this.node).id,selector:this.selector,command:"editImage",undo:this.lastValue,redo:this.getValue()}))}this.lastValue=this.getValue()},getValue:function(){var e={type:"",src:"",id:-1,alt:""};if(t(this)){e.type="background";e.src=a(this);e.id=s(this)}if(n(this)){e.type="image";e.src=o(this);e.id=s(this);e.alt=d(this)}return e}}})();