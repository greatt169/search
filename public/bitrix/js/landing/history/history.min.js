(function(){"use strict";BX.namespace("BX.Landing");var n="undo";var t="redo";var i="init";var o="resolved";var e="pending";var r=BX.Landing.Utils.isPlainObject;var s=BX.Landing.Utils.bind;var a=BX.Landing.Utils.fireCustomEvent;BX.Landing.History=function(){this.stack=[];this.commands={};this.position=-1;this.state=i;this.commandState=o;this.onStorage=this.onStorage.bind(this);s(window,"storage",this.onStorage);d(this).then(l).then(B)};BX.Landing.History.instance=null;BX.Landing.History.getInstance=function(){if(!top.BX.Landing.History.instance){top.BX.Landing.History.instance=new BX.Landing.History}return top.BX.Landing.History.instance};function d(i){i.registerCommand(new BX.Landing.History.Command({id:"editText",undo:BX.Landing.History.Action.editText.bind(null,n),redo:BX.Landing.History.Action.editText.bind(null,t)}));i.registerCommand(new BX.Landing.History.Command({id:"editImage",undo:BX.Landing.History.Action.editImage.bind(null,n),redo:BX.Landing.History.Action.editImage.bind(null,t)}));i.registerCommand(new BX.Landing.History.Command({id:"editIcon",undo:BX.Landing.History.Action.editIcon.bind(null,n),redo:BX.Landing.History.Action.editIcon.bind(null,t)}));i.registerCommand(new BX.Landing.History.Command({id:"editLink",undo:BX.Landing.History.Action.editLink.bind(null,n),redo:BX.Landing.History.Action.editLink.bind(null,t)}));i.registerCommand(new BX.Landing.History.Command({id:"sortBlock",undo:BX.Landing.History.Action.sortBlock.bind(null,n),redo:BX.Landing.History.Action.sortBlock.bind(null,t)}));i.registerCommand(new BX.Landing.History.Command({id:"addBlock",undo:BX.Landing.History.Action.removeBlock.bind(null,n),redo:BX.Landing.History.Action.addBlock.bind(null,t)}));i.registerCommand(new BX.Landing.History.Command({id:"removeBlock",undo:BX.Landing.History.Action.addBlock.bind(null,n),redo:BX.Landing.History.Action.removeBlock.bind(null,t)}));i.registerCommand(new BX.Landing.History.Command({id:"updateStyle",undo:BX.Landing.History.Action.editStyle.bind(null,n),redo:BX.Landing.History.Action.editStyle.bind(null,t)}));i.registerCommand(new BX.Landing.History.Command({id:"addCard",undo:BX.Landing.History.Action.removeCard.bind(null,n),redo:BX.Landing.History.Action.addCard.bind(null,t)}));i.registerCommand(new BX.Landing.History.Command({id:"removeCard",undo:BX.Landing.History.Action.addCard.bind(null,n),redo:BX.Landing.History.Action.removeCard.bind(null,t)}));return Promise.resolve(i)}function c(n){return new Promise(function(t){var i=new Worker("/bitrix/js/landing/history/worker/json-parse-worker.js");i.postMessage(n);i.addEventListener("message",function(n){t(n.data)})})}function u(n){return new Promise(function(t){var i=new Worker("/bitrix/js/landing/history/worker/json-stringify-worker.js");i.postMessage(n);i.addEventListener("message",function(n){t(n.data)})})}function l(n){var t;try{t=BX.Landing.Main.getInstance().id}catch(n){t=-1}return c(window.localStorage.history).then(function(n){return r(n)&&t in n?n[t]:Promise.reject()}).then(function(t){Object.keys(t.stack).forEach(function(i){n.stack.push(new BX.Landing.History.Entry(t.stack[i]))});n.position=parseInt(t.position);n.state=t.state;return n}).catch(function(){return n})}function m(n){var t;try{t=BX.Landing.Main.getInstance().id}catch(n){t=-1}return c(window.localStorage.history).then(function(n){return r(n)?n:{}}).then(function(i){i[t]={};i[t].stack=n.stack;i[t].position=n.position;i[t].state=n.state;return i}).then(u).then(function(t){window.localStorage.history=t;return n})}function g(n){n.stack=[];n.position=-1;n.state=i;n.commandState=o;return Promise.resolve(n)}function h(n,t){return c(window.localStorage.history).then(function(n){return r(n)?n:{}}).then(function(t){if(n in t){delete t[n]}return t}).then(u).then(function(n){window.localStorage.history=n;return t})}function f(i,r){if(i.commandState===e){return Promise.resolve(i)}var s=i.position+r;var a=i.state;if(r<0&&i.state!==n){s+=1;a=n}if(r>0&&i.state!==t){s-=1;a=t}if(s<=i.stack.length-1&&s>=0){i.position=s;i.state=a;var d=i.stack[s];if(d){var c=i.commands[d.command];if(c){i.commandState=e;return c[a](d).then(function(){i.commandState=o;return i}).catch(function(){i.commandState=o;return i[a===n?"undo":"redo"]()})}}}return Promise.resolve(i)}function B(n){a(top.window,"BX.Landing.History:init",[n]);return Promise.resolve(n)}function y(n){a(top.window,"BX.Landing.History:update",[n]);return Promise.resolve(n)}function L(n){a(top.window,"BX.Landing.History:actualize",[n]);return Promise.resolve(n)}function X(n){a(top.window,"BX.Landing.History:newBranch",[n]);return Promise.resolve(n)}function w(n,t){return Promise.resolve(t)}function H(n,t){var i={blocks:[],images:[]};n.forEach(function(n){if(n.command==="addBlock"){i.blocks.push(n.block)}if(n.command==="editImage"){i.images.push({block:n.block,id:n.redo.id})}});return Promise.resolve(i)}BX.Landing.History.prototype={undo:function(){if(this.canUndo()){return f(this,-1).then(m).then(y)}return Promise.resolve(this)},redo:function(){if(this.canRedo()){return f(this,1).then(m).then(y)}return Promise.resolve(this)},canUndo:function(){return this.position>0&&this.state===t||this.position>0&&this.state===n||this.position===0&&this.state!==n},canRedo:function(){return this.position<this.stack.length-1&&this.state!==i||this.position!==-1&&this.position===this.stack.length-1&&this.state!==t},push:function(i){var o=this.position+1;var e=this.stack.length;if(this.state===n){o-=1}var r=this.stack.splice(o,e,i);if(r.length){this.onNewBranch(r)}this.position=this.stack.length-1;this.state=t;m(this).then(y)},registerCommand:function(n){if(n instanceof BX.Landing.History.Command){this.commands[n.id]=n}},removePageHistory:function(n){return h(n,this).then(function(t){var i;try{i=BX.Landing.Main.getInstance().id}catch(n){i=-1}if(i===n){return g(t)}return Promise.reject()}).then(y).catch(function(){})},onStorage:function(n){if(n.key===null){if(!window.localStorage.history){g(this).then(y)}}},onNewBranch:function(n){return H(n,this).then(function(n){return w(n,this)}.bind(this))}}})();