(function(){"use strict";BX.namespace("BX.Landing.UI.Panel");var n=BX.Landing.Utils.addClass;var t=BX.Landing.Utils.removeClass;var i=BX.Landing.Utils.append;var e=BX.Landing.Utils.onCustomEvent;var a=BX.Landing.Utils.setTextContent;var s=BX.Landing.Utils.rect;var r=BX.Landing.Utils.style;var o=BX.Landing.Utils.join;var d=BX.Landing.Utils.isNumber;var h=BX.Landing.Utils.isString;var c=BX.Landing.Utils.isPlainObject;var l=BX.Landing.Cache;var g="landing";var u="block";var L="system";BX.Landing.UI.Panel.URLList=function(t,a){BX.Landing.UI.Panel.Content.apply(this,arguments);n(this.layout,"landing-ui-panel-url-list");n(this.overlay,"landing-ui-panel-url-list-overlay");n(this.overlay,"landing-ui-hide");this.overlay.hidden=true;this.overlay.dataset.isShown="false";e("BX.Landing.Block:init",this.refresh.bind(this));e("BX.Landing.Block:remove",this.refresh.bind(this));i(this.layout,document.body);this.loader=new BX.Landing.UI.Card.Loader({id:"url_list_loader"});this.appendCard(this.loader);this.promiseResolve=function(){};this.layout.hidden=true;this.isNeedLoad=true;this.cache=new l};BX.Landing.UI.Panel.URLList.getInstance=function(){if(!BX.Landing.UI.Panel.URLList.instance){BX.Landing.UI.Panel.URLList.instance=new BX.Landing.UI.Panel.URLList("url_list")}return BX.Landing.UI.Panel.URLList.instance};BX.Landing.UI.Panel.URLList.instance=null;BX.Landing.UI.Panel.URLList.prototype={constructor:BX.Landing.UI.Panel.URLList,__proto__:BX.Landing.UI.Panel.Content.prototype,refresh:function(){this.isNeedLoad=true},showLoader:function(){this.appendCard(this.loader);this.loader.show()},show:function(i,e){BX.Landing.UI.Panel.Content.prototype.show.call(this);this.clear();this.showLoader();if(i===g){t(this.layout,"landing-ui-panel-url-list-blocks");a(this.title,BX.message("LANDING_LINKS_LANDINGS_TITLE"));this.showSites(e)}else{n(this.layout,"landing-ui-panel-url-list-blocks");a(this.title,BX.message("LANDING_LINKS_BLOCKS_TITLE"));this.showBlocks(e)}return new Promise(function(n){this.promiseResolve=n}.bind(this))},showSites:function(n){var t=n.siteId;void this.getSites(n).then(function(i){this.appendSidebarButton(new BX.Landing.UI.Button.SidebarButton("current_site",{text:BX.message("LANDING_LINKS_PANEL_CURRENT_SITE")}));i.forEach(function(n){if(parseInt(n.ID)==t){this.appendSidebarButton(new BX.Landing.UI.Button.SidebarButton(n.ID,{text:n.TITLE,onClick:this.onSiteClick.bind(this,n.ID),child:true,active:true}))}},this);this.getLandings(t).then(function(n){n.forEach(function(n){this.appendCard(new BX.Landing.UI.Card.LandingPreviewCard({title:n.TITLE,description:n.DESCRIPTION,preview:n.PREVIEW,onClick:this.onLandingClick.bind(this,n.ID,n.TITLE)}))},this);var t=this.getSystemPages();Object.keys(t).forEach(function(n){var i=t[n];this.appendCard(new BX.Landing.UI.Card.LandingPreviewCard({title:i.name,description:i.description,preview:i.preview,onClick:this.onSystemClick.bind(this,n,i.name)}))},this);this.loader.hide()}.bind(this));if(!n.currentSiteOnly){this.appendSidebarButton(new BX.Landing.UI.Button.SidebarButton("my_sites",{text:BX.message("LANDING_LINKS_PANEL_MY_SITES")}));i.forEach(function(n){this.appendSidebarButton(new BX.Landing.UI.Button.SidebarButton(n.ID,{text:n.TITLE,onClick:this.onSiteClick.bind(this,n.ID),child:true}))},this)}}.bind(this))},getSystemPages:function(){var n;try{n=BX.Landing.Main.getInstance().options.syspages;if(!c(n)){n={}}}catch(t){n={}}return n},showBlocks:function(n){var t=n.landingId;void this.getBlocks(t,n).then(function(n){n.forEach(function(n){var t=this.createBlockPreview(n);this.appendCard(t);requestAnimationFrame(function(){var n=s(t.block);var i=s(t.layout);var e=Math.min(i.width/n.width,i.height/n.height);void r(t.block,{transform:o("translate(-50%, -50%) ","scale(",e,")")})})},this);this.loader.hide()}.bind(this))},onBlockClick:function(n,t){this.onChange({type:u,id:n,name:t})},onLandingClick:function(n,t){this.onChange({type:g,id:n,name:t})},onSystemClick:function(n,t){this.onChange({type:L,id:"_"+n,name:t})},onSiteClick:function(n,t){this.sidebarButtons.forEach(function(n){if(n.layout===event.currentTarget){n.activate()}else{n.deactivate()}});this.content.innerHTML="";this.showLoader();this.getLandings(n,t).then(function(n){n.forEach(function(n){this.appendCard(this.createLandingPreview(n))},this);this.loader.hide()}.bind(this))},createLandingPreview:function(n){return new BX.Landing.UI.Card.LandingPreviewCard({title:n.TITLE,description:n.DESCRIPTION,preview:n.PREVIEW,onClick:this.onLandingClick.bind(this,n.ID,n.TITLE)})},createBlockPreview:function(n){return new BX.Landing.UI.Card.BlockHTMLPreview({content:n.id,onClick:this.onBlockClick.bind(this,n.id,n.name)})},getSites:function(n){if(this.cache.has(n)){return Promise.resolve(this.cache.get(n))}return BX.Landing.Backend.getInstance().action("Site::getList",{params:{order:{ID:"DESC"},filter:n.filter}}).then(function(t){this.cache.add(n,t);return t}.bind(this))},getLandings:function(n,t){n=d(n)||h(n)?n:t.siteId;if(this.cache.has("getLandings"+n)){return Promise.resolve(this.cache.get("getLandings"+n))}return BX.Landing.Backend.getInstance().action("Landing::getList",{params:{filter:{SITE_ID:n},order:{ID:"DESC"},get_preview:true}}).then(function(t){this.cache.add("getLandings"+n,t);return t}.bind(this))},getLanding:function(n,t){if(this.cache.has(["getLanding"+n,t])){return Promise.resolve(this.cache.get(["getLanding"+n,t]))}return BX.Landing.Backend.getInstance().action("Landing::getList",{params:{filter:{ID:n},get_preview:true}}).then(function(i){this.cache.add(["getLanding"+n,t],i);return i}.bind(this))},getBlocks:function(n,t){n=d(n)||h(n)?n:t.id;if(this.cache.has(["getBlocks"+n,t])){return Promise.resolve(this.cache.get(["getBlocks"+n,t]))}return BX.Landing.Backend.getInstance().action("Block::getList",{lid:n,params:{get_content:true,edit_mode:true}}).then(function(i){this.cache.add(["getBlocks"+n,t],i);return i}.bind(this))},getEntries:function(){return new Promise(function(n){if(this.isNeedLoad){this.getLandings().then(function(t){var i=Promise.all(t.map(function(n){return this.getBlocks(n.ID)},this));i.then(function(i){var e=t.map(function(n,t){var e=i[t];if(c(e)){var a=Object.keys(e);e=a.map(function(n){return i[t][n]})}n.blocks=e;return n});this.lastEntries=e;this.isNeedLoad=false;n(e)}.bind(this))}.bind(this))}else{n(this.lastEntries)}}.bind(this))},onChange:function(n){this.promiseResolve(n);this.hide()}}})();