(function(){"use strict";BX.namespace("BX.Landing");var t=BX.Landing.Utils.deepFreeze;var e=BX.Landing.Utils.style;var n=BX.Landing.Utils.insertAfter;var i=BX.Landing.Utils.insertBefore;var s=BX.Landing.Utils.append;var a=BX.Landing.Utils.isPlainObject;var o=BX.Landing.Utils.isBoolean;var r=BX.Landing.Utils.isNumber;var d=BX.Landing.Utils.isString;var l=BX.Landing.Utils.isArray;var c=BX.Landing.Utils.isEmpty;var h=BX.Landing.Utils.addClass;var u=BX.Landing.Utils.removeClass;var f=BX.Landing.Utils.hasClass;var g=BX.Landing.Utils.create;var p=BX.Landing.Utils.debounce;var m=BX.Landing.Utils.fireCustomEvent;var B=BX.Landing.Utils.onCustomEvent;var v=BX.Landing.Utils.bind;var b=BX.Landing.Utils.unbind;var k=BX.Landing.Utils.getClass;var L=BX.Landing.Utils.rect;var C=BX.Landing.Utils.setTextContent;var y=BX.Landing.Utils.translateY;var I=BX.Landing.Utils.nextSibling;var E=BX.Landing.Utils.prevSibling;var X=BX.Landing.Utils.join;var T=BX.Landing.Utils.slice;var _=BX.Landing.Utils.decodeDataValue;var N=BX.Landing.Utils.encodeDataValue;var A=BX.Landing.Utils.data;var O=BX.Landing.Utils.removePanels;var w=BX.Landing.Utils.getCSSSelector;var S=BX.Landing.Utils.remove;var P=BX.Landing.Utils.clone;var U=BX.Landing.Utils.trim;var M=BX.Landing.Utils.prepend;var D=BX.Landing.Utils.random;var F=BX.Landing.Utils.htmlToElement;var x=BX.Landing.Utils.proxy;var j=BX.Landing.Collection.BaseCollection;var R=BX.Landing.Collection.NodeCollection;var G=BX.Landing.UI.Collection.FormCollection;var V=BX.Landing.Collection.CardCollection;var q=BX.Landing.UI.Collection.PanelCollection;var H=BX.Landing.UI.Panel.BaseButtonPanel;var K=BX.Landing.UI.Panel.CardAction;var z=BX.Landing.UI.Panel.ContentEdit;var W=BX.Landing.UI.Button.BaseButton;var Y=BX.Landing.UI.Button.Action;var J=BX.Landing.UI.Button.Plus;var Q=BX.Landing.UI.Button.CardAction;var Z=BX.Landing.UI.Factory.StyleFactory;var $=BX.Landing.UI.Form.BaseForm;var tt=BX.Landing.UI.Form.StyleForm;var et=BX.Landing.UI.Form.CardForm;var nt=BX.Landing.UI.Form.CardsForm;var it=BX.Landing.Group;var st=BX.Landing.Event.Block;var at=BX.Landing.UI.Card.TabCard;var ot=BX.Landing.UI.Tool.Menu;var rt=BX.Landing.Backend.getInstance();var dt="D";var lt="V";var ct="W";var ht="X";function ut(t){var e=BX.Landing.Main.getInstance();return e.options.style["bitrix"]["style"][t]}function ft(t){var e=BX.Landing.Main.getInstance();return t in e.options.style["bitrix"]["group"]}function gt(t){var e=BX.Landing.Main.getInstance();return e.options.style["bitrix"]["group"][t]}function pt(t){if(!!t){if(!t.loader){t.loader=new BX.Loader({target:t.layout,size:16});void e(t.loader.layout.querySelector(".main-ui-loader-svg-circle"),{"stroke-width":"4px"})}t.loader.show();h(t.text,"landing-ui-hide-icon")}}function mt(t){if(!!t){if(t.loader){t.loader.hide();u(t.text,"landing-ui-hide-icon")}}}function Bt(t){return!!t&&t.includes("@")}BX.Landing.Block=function(e,n){this.node=e;this.parent=e.parentElement;this.content=e.firstElementChild;this.siteId=A(e.parentElement,"data-site");this.lid=A(e.parentElement,"data-landing");this.id=r(parseInt(n.id))?parseInt(n.id):0;this.selector=X("#block",r(n.id)?n.id:0," > :first-child");this.active=o(n.active)?n.active:true;this.manifest=a(n.manifest)?n.manifest:{};this.manifest.nodes=a(n.manifest.nodes)?n.manifest.nodes:{};this.manifest.cards=a(n.manifest.cards)?n.manifest.cards:{};this.manifest.attrs=a(n.manifest.attrs)?n.manifest.attrs:{};this.onStyleInputWithDebounce=p(this.onStyleInput,1e3,this);this.changeTimeout=null;this.access=n.access;this.nodes=new R;this.cards=new V;this.panels=new q;this.groups=new j;this.changedNodes=new j;this.styles=new j;this.forms=new G;if(a(n.requiredUserAction)&&!c(n.requiredUserAction)){this.showRequiredUserAction(n.requiredUserAction);this.requiredUserActionIsShown=true}this.onEditorEnabled=this.onEditorEnabled.bind(this);this.onEditorDisabled=this.onEditorDisabled.bind(this);this.adjustPanelsPosition=this.adjustPanelsPosition.bind(this);this.onMouseMove=this.onMouseMove.bind(this);this.onStorage=this.onStorage.bind(this);this.onBlockRemove=this.onBlockRemove.bind(this);this.onBlockInit=this.onBlockInit.bind(this);t(this.manifest);this.node.classList[this.active?"remove":"add"]("landing-block-disabled");this.state="ready";this.initPanels();this.initStyles();this.adjustContextSensitivityStyles();top.BX.Landing.Block.storage.push(this);m(window,"BX.Landing.Block:init",[this.createEvent()]);B("BX.Landing.Editor:enable",this.onEditorEnabled);B("BX.Landing.Editor:disable",this.onEditorDisabled);B("BX.Landing.Block:afterRemove",this.onBlockRemove);B("BX.Landing.Block:init",this.onBlockInit);v(this.node,"mousemove",this.onMouseMove);v(this.node,"keydown",this.adjustPanelsPosition);v(top,"storage",this.onStorage)};BX.Landing.Block.storage=new BX.Landing.Collection.BlockCollection;BX.Landing.Block.prototype={onMouseMove:function(){if(this.state==="ready"){b(this.node,"mousemove",this.onMouseMove);this.initEntities();this.lazyInitPanels();this.state="complete"}},showRequiredUserAction:function(t){this.node.innerHTML='<div class="landing-block-user-action">'+'<div class="landing-block-user-action-inner">'+(t.header?"<h3>"+t.header+"</h3>":"")+(t.description?"<p>"+t.description+"</p>":"")+(t.href&&t.text?"<div>"+'<a href="'+t.href+'" class="ui-btn">'+t.text+"</a>"+"</div>":"")+"</div>"+"</div>"},disableLinks:function(){var t="a:not([class*='landing-ui']):not(.landing-trusted-link), .btn:not([class*='landing-ui']):not(.landing-trusted-link), button:not([class*='landing-ui']):not(.landing-trusted-link), input:not([class*='landing-ui'])";var e=T(this.content.querySelectorAll(t));e.forEach(function(t){var e=this.nodes.some(function(e){return e.node.contains(t)});if(!this.nodes.getByNode(t)&&!e){t.style.pointerEvents="none"}},this)},adjustContextSensitivityStyles:function(){if(f(this.parent,"landing-sidebar")){if(!f(this.content,"landing-adjusted")){var t=Object.keys(this.manifest.style.nodes);var e=t.filter(function(t){return!!this.manifest.style.nodes[t].type&&this.manifest.style.nodes[t].type.indexOf("columns")!==-1},this);if(c(e)){return}var n=ut("columns");e.forEach(function(t){var e=this.styles.get(t);if(e){e.setValue("col-lg-12",n.items)}},this);var i=this.styles.get(this.selector);if(i){i.setValue("landing-adjusted",["landing-adjusted"])}this.saveStyles()}}},forceInit:function(){this.onMouseMove()},createEvent:function(t){return new st({block:this.node,node:!!t&&!!t.node?t.node:null,card:!!t&&!!t.card?t.card:null,data:!!t&&t.data,onForceInit:this.forceInit.bind(this)})},initEntities:function(){this.initCards();this.initNodes();this.initGroups();this.initCardsLabels();this.disableLinks()},initCardsLabels:function(){this.cards.forEach(function(t){t.label=this.createCardLabel(t.node,t.manifest)},this)},initGroups:function(){var t=[];var e=a(this.manifest.groups)?this.manifest.groups:{};this.nodes.forEach(function(e){if(d(e.manifest.group)&&!t.includes(e.manifest.group)){t.push(e.manifest.group)}});t.forEach(function(t){var n=this.nodes.filter(function(e){return e.manifest.group===t});this.groups.add(new it({id:t,name:e[t],nodes:n,onClick:this.onGroupClick.bind(this)}))},this)},onGroupClick:function(t){this.showContentPanel({name:t.name,nodes:t.nodes,compact:true,nodesOnly:true})},initPanels:function(){if(!this.panels.get("create_action")){var t=new H("create_action","landing-ui-panel-create-action");t.addButton(new J("insert_after",{text:BX.message("ACTION_BUTTON_CREATE"),onClick:this.addBlockAfterThis.bind(this)}));t.show();this.addPanel(t);t.buttons[0].on("mouseover",this.onCreateButtonMouseover.bind(this));t.buttons[0].on("mouseout",this.onCreateButtonMouseout.bind(this))}},isLastChildInArea:function(){return this.parent.querySelector("[class*='block-wrapper']:last-of-type")===this.node},onCreateButtonMouseover:function(){if(this.isLastChildInArea()||f(this.parent,"landing-header")||f(this.parent,"landing-footer")){var t=BX.Landing.Main.getInstance().getLayoutAreas();if(t.length>1){var e=this.panels.get("create_action").buttons[0];if(f(this.parent,"landing-header")){e.setText(BX.message("ACTION_BUTTON_CREATE")+" "+BX.message("LANDING_ADD_BLOCK_TO_HEADER"))}if(f(this.parent,"landing-sidebar")){e.setText(BX.message("ACTION_BUTTON_CREATE")+" "+BX.message("LANDING_ADD_BLOCK_TO_SIDEBAR"))}if(f(this.parent,"landing-footer")){e.setText(BX.message("ACTION_BUTTON_CREATE")+" "+BX.message("LANDING_ADD_BLOCK_TO_FOOTER"))}if(f(this.parent,"landing-main")){e.setText(BX.message("ACTION_BUTTON_CREATE")+" "+BX.message("LANDING_ADD_BLOCK_TO_MAIN"))}clearTimeout(this.fadeTimeout);this.fadeTimeout=setTimeout(function(){h(this.parent,"landing-area-highlight");t.forEach(function(t){if(t!==this.parent){h(t,"landing-area-fade")}},this)}.bind(this),400)}}},onCreateButtonMouseout:function(){clearTimeout(this.fadeTimeout);if(this.isLastChildInArea()||f(this.parent,"landing-header")||f(this.parent,"landing-footer")){var t=BX.Landing.Main.getInstance().getLayoutAreas();if(t.length>1){var e=this.panels.get("create_action").buttons[0];e.setText(BX.message("ACTION_BUTTON_CREATE"));u(this.parent,"landing-area-highlight");t.forEach(function(t){u(t,"landing-area-fade")},this)}}},lazyInitPanels:function(){if(!this.panels.contains("content_actions")&&!this.requiredUserActionIsShown){var t=new H("content_actions","landing-ui-panel-content-action");t.addButton(new Y("collapse",{html:"<span class='fa fa-caret-right'></span>",onClick:this.onCollapseActionPanel.bind(this),attrs:{title:BX.message("LANDING_TITLE_OF_BLOCK_ACTION_COLLAPSE")}}));if(a(this.manifest.nodes)){t.addButton(new Y("content",{text:BX.message("ACTION_BUTTON_CONTENT"),onClick:this.onShowContentPanel.bind(this),disabled:this.access<ct,attrs:{title:BX.message("LANDING_TITLE_OF_BLOCK_EDIT")}}))}if(a(this.manifest.style)){t.addButton(new Y("style",{text:BX.message("ACTION_BUTTON_STYLE"),onClick:this.onStyleShow.bind(this),disabled:this.access<lt,attrs:{title:BX.message("LANDING_TITLE_OF_BLOCK_DESIGN")}}))}var e=BX.Landing.Main.getInstance().options.placements.blocks;if(a(e)&&(this.manifest.code in e||e["*"])){var n=[];if(this.manifest.code in e){Object.keys(e[this.manifest.code]).forEach(function(t){n.push(e[this.manifest.code][t])},this)}if(e["*"]){Object.keys(e["*"]).forEach(function(t){n.push(e["*"][t])},this)}if(n.length){t.addButton(new Y("actions",{html:BX.message("ACTION_BUTTON_CONTENT_MORE"),onClick:this.onPlacementButtonClick.bind(this,n)}))}h(t.buttons.get("style").layout,"landing-ui-no-rounded")}if(a(this.manifest.style)){var i=new Y("block_display_info",{html:"&nbsp;"});v(i.layout,"mouseenter",this.onBlockDisplayMouseenter.bind(this));v(i.layout,"mouseleave",this.onBlockDisplayMouseleave.bind(this));t.addButton(i)}t.show();this.addPanel(t)}if(!this.panels.get("block_action")){var s=new H("block_action","landing-ui-panel-block-action");var o=this.getBlockFromRepository(this.manifest.code);if(o&&o.restricted){var r=new Y("restricted",{html:"&nbsp;",className:"landing-ui-block-restricted-button",onClick:this.onRestrictedButtonClick.bind(this)});v(r.layout,"mouseenter",this.onRestrictedButtonMouseenter.bind(this));v(r.layout,"mouseleave",this.onRestrictedButtonMouseleave.bind(this));s.addButton(r)}s.addButton(new Y("down",{html:BX.message("ACTION_BUTTON_DOWN"),onClick:this.moveDown.bind(this),attrs:{title:BX.message("LANDING_TITLE_OF_BLOCK_ACTION_SORT_DOWN")}}));s.addButton(new Y("up",{html:BX.message("ACTION_BUTTON_UP"),onClick:this.moveUp.bind(this),attrs:{title:BX.message("LANDING_TITLE_OF_BLOCK_ACTION_SORT_UP")}}));s.addButton(new Y("actions",{html:BX.message("ACTION_BUTTON_ACTIONS"),onClick:this.showBlockActionsMenu.bind(this),attrs:{title:BX.message("LANDING_TITLE_OF_BLOCK_ACTION_ADDITIONAL_ACTIONS")}}));s.addButton(new Y("remove",{html:BX.message("ACTION_BUTTON_REMOVE"),disabled:this.access<ht,onClick:this.deleteBlock.bind(this),attrs:{title:BX.message("LANDING_TITLE_OF_BLOCK_ACTION_REMOVE")}}));s.addButton(new Y("collapse",{html:"<span class='fa fa-caret-right'></span>",onClick:this.onCollapseActionPanel.bind(this),attrs:{title:BX.message("LANDING_TITLE_OF_BLOCK_ACTION_COLLAPSE")}}));s.show();this.addPanel(s)}this.adjustPanelsPosition();this.adjustSortButtonsState()},onCollapseActionPanel:function(){if(!f(this.parent,"landing-ui-collapse")){h(this.parent,"landing-ui-collapse")}else{u(this.parent,"landing-ui-collapse")}},getBlockFromRepository:function(t){var e=BX.Landing.Main.getInstance().options.blocks;var n=Object.keys(e);var i=n.find(function(n){return t in e[n].items});if(i){return e[i].items[t]}},onRestrictedButtonClick:function(t){t.preventDefault()},onPlacementClick:function(t){BX.rest.AppLayout.openApplication(t.app_id,{ID:this.id,CODE:this.manifest.code,LID:BX.Landing.Main.getInstance().id},{PLACEMENT:"LANDING_BLOCK_"+t.placement,PLACEMENT_ID:t.id});if(this.blockPlacementsActionsMenu){this.blockPlacementsActionsMenu.close()}},onPlacementButtonClick:function(t){this.panels.get("content_actions").buttons.get("actions").activate();if(!this.blockPlacementsActionsMenu){var e=this.panels.get("content_actions").buttons.get("actions");var n=X("block_",this.id,"content_placement_actions_",D());var i=t.map(function(t){return new BX.PopupMenuItem({id:"placement_"+t.id+"_"+D(),text:t.title,onclick:this.onPlacementClick.bind(this,t)})},this);this.blockPlacementsActionsMenu=new ot({id:n,bindElement:e.layout,items:i,angle:{position:"top",offset:80},offsetTop:-6,events:{onPopupClose:function(){this.panels.get("content_actions").buttons.get("actions").deactivate();u(this.node,"landing-ui-hover")}.bind(this)}})}h(this.node,"landing-ui-hover");this.blockPlacementsActionsMenu.show()},onRestrictedButtonMouseenter:function(t){clearTimeout(this.displayBlockTimer);this.displayBlockTimer=setTimeout(function(t){BX.Landing.UI.Tool.Suggest.getInstance().show(t,{description:BX.message("LANDING_BLOCK_RESTRICTED_TEXT")})}.bind(this),200,t.currentTarget)},onRestrictedButtonMouseleave:function(){clearTimeout(this.displayBlockTimer);BX.Landing.UI.Tool.Suggest.getInstance().hide()},onBlockDisplayMouseenter:function(t){clearTimeout(this.displayBlockTimer);this.displayBlockTimer=setTimeout(function(t){BX.Landing.UI.Tool.Suggest.getInstance().show(t,{name:g("div",{props:{className:"landing-ui-block-display-message-header"},html:BX.message("LANDING_BLOCK_DISABLED_ON_DESKTOP_NAME")}).outerHTML,description:this.getBlockDisplayItems()})}.bind(this),300,t.currentTarget)},onBlockDisplayMouseleave:function(){clearTimeout(this.displayBlockTimer);BX.Landing.UI.Tool.Suggest.getInstance().hide()},getBlockDisplayItems:function(){function t(t){return g("div",{props:{className:"landing-ui-block-display-message"},attrs:{"data-mod":t},children:[g("div",{props:{className:"landing-ui-block-display-message-left"},html:"&nbsp;"}),g("div",{props:{className:"landing-ui-block-display-message-right"},children:[g("p",{html:BX.message("LANDING_BLOCK_HIDDEN_ON_"+(t?t.toUpperCase():""))})]})]})}var e=g("div");if(f(this.content,"l-d-lg-none")){e.appendChild(t("desktop"))}if(f(this.content,"l-d-md-none")){e.appendChild(t("tablet"))}if(f(this.content,"l-d-xs-none")){e.appendChild(t("mobile"))}return e.outerHTML},adjustPanelsPosition:function(){var t=L(this.node);var e=this.panels.get("content_actions");var n=this.panels.get("block_action");if(t.height<80){if(e){h(e.layout,"landing-ui-panel-actions-compact")}if(n){h(n.layout,"landing-ui-panel-actions-compact")}}else{if(e){u(e.layout,"landing-ui-panel-actions-compact")}if(n){u(n.layout,"landing-ui-panel-actions-compact")}}},onEditorEnabled:function(t){if(this.node.contains(t)){h(this.node,"landing-ui-hover")}},onEditorDisabled:function(){u(this.node,"landing-ui-hover")},onStorage:function(){if(this.blockActionsMenu){var t=this.blockActionsMenu.getMenuItem("block_paste");if(t){if(window.localStorage.landingBlockId){t.layout.item.setAttribute("title",window.localStorage.landingBlockName);u(t.layout.item,"landing-ui-disabled");h(t.layout.item,"menu-popup-no-icon")}else{t.layout.item.setAttribute("title","");h(t.layout.item,"landing-ui-disabled")}}}},showBlockActionsMenu:function(){this.panels.get("block_action").buttons.get("actions").activate();if(!this.blockActionsMenu){var t=f(this.node.parentElement,"landing-sidebar");var e=this.panels.get("block_action").buttons.get("actions");var n=X("block_",this.id,"_actions_",D());var i=BX.Landing.Main.getInstance();this.blockActionsMenu=new ot({id:n,bindElement:e.layout,className:"landing-ui-block-actions-popup",angle:{position:"top",offset:t?70:146},offsetTop:-6,offsetLeft:-26,events:{onPopupClose:function(){this.panels.get("block_action").buttons.get("actions").deactivate();u(this.node,"landing-ui-hover")}.bind(this)},items:[new BX.PopupMenuItem({id:"show_hide",text:BX.message(this.isEnabled()?"ACTION_BUTTON_HIDE":"ACTION_BUTTON_SHOW"),className:this.access<ct?"landing-ui-disabled":"",onclick:function(){this.onStateChange();this.blockActionsMenu.close()}.bind(this)}),new BX.PopupMenuItem({text:BX.message("ACTION_BUTTON_ACTIONS_CUT"),className:this.access<ht?"landing-ui-disabled":"",onclick:function(){i.onCutBlock.bind(i,this)();this.blockActionsMenu.close()}.bind(this)}),new BX.PopupMenuItem({text:BX.message("ACTION_BUTTON_ACTIONS_COPY"),onclick:function(){i.onCopyBlock.bind(i,this)();this.blockActionsMenu.close()}.bind(this)}),new BX.PopupMenuItem({id:"block_paste",text:BX.message("ACTION_BUTTON_ACTIONS_PASTE"),title:window.localStorage.landingBlockName,className:window.localStorage.landingBlockId?"":"landing-ui-disabled",onclick:function(){i.onPasteBlock.bind(i,this)();this.blockActionsMenu.close()}.bind(this)}),new BX.PopupMenuItem({text:BX.message("LANDING_BLOCKS_ACTIONS_FEEDBACK_BUTTON"),onclick:function(){BX.Landing.Main.getInstance().showSliderFeedbackForm({blockName:this.manifest.block.name,blockCode:this.manifest.code,blockSection:this.manifest.block.section,landingId:BX.Landing.Main.getInstance().id,target:"blockActions"});this.blockActionsMenu.close()}.bind(this)})]})}h(this.node,"landing-ui-hover");this.blockActionsMenu.show()},moveUp:function(t){var n=E(this.node,"block-wrapper");var s=this.node;if(n){var a=Promise.all([y(s,-L(n).height),y(n,L(s).height)]);a.then(function(){void e(s,{transform:null,transition:null});void e(n,{transform:null,transition:null});i(s,n);if(!t||typeof t==="object"){BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:this.id,selector:"#block"+this.id,command:"sortBlock",undo:"moveDown",redo:"moveUp"}))}}.bind(this));rt.action("Landing::upBlock",{block:this.id,lid:this.lid,siteId:this.siteId},{code:this.manifest.code})}},moveDown:function(t){var i=I(this.node,"block-wrapper");var s=this.node;if(!!i){var a=Promise.all([y(s,L(i).height),y(i,-L(s).height)]);a.then(function(){void e(s,{transform:null,transition:null});void e(i,{transform:null,transition:null});n(s,i);if(!t||typeof t==="object"){BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:this.id,selector:"#block"+this.id,command:"sortBlock",undo:"moveUp",redo:"moveDown"}))}}.bind(this));rt.action("Landing::downBlock",{block:this.id,lid:this.lid,siteId:this.siteId},{code:this.manifest.code})}},addPanel:function(t,e){if(!this.panels.contains(t)){this.panels.add(t);if(!e){s(t.layout,this.node)}else{i(t.layout,e)}}},onShowContentPanel:function(){this.showContentPanel();BX.Landing.UI.Panel.EditorPanel.getInstance().hide()},onStateChange:function(){if(this.isEnabled()){this.disable()}else{this.enable()}},isEnabled:function(){return this.active},enable:function(){this.active=true;u(this.node,"landing-block-disabled");C(this.blockActionsMenu.getMenuItem("show_hide").getLayout().text,BX.message("ACTION_BUTTON_HIDE"));rt.action("Landing::showBlock",{block:this.id,lid:this.lid,siteId:this.siteId},{code:this.manifest.code})},disable:function(){this.active=false;h(this.node,"landing-block-disabled");C(this.blockActionsMenu.getMenuItem("show_hide").getLayout().text,BX.message("ACTION_BUTTON_SHOW"));rt.action("Landing::hideBlock",{block:this.id,lid:this.lid,siteId:this.siteId},{code:this.manifest.code})},createCardLabel:function(t,e){var n=[];if(d(e.label)){n.push(e.label)}else if(l(e.label)){n=n.concat(e.label)}var i=this.nodes.filter(function(e){return t.contains(e.node)});var s=[];n.forEach(function(t){var e=i.find(function(e){return e.manifest.code===t});if(e){var n;if(e instanceof BX.Landing.Block.Node.Text){n=g("span",{props:{className:"landing-card-title-text"},html:g("div",{html:e.getValue()}).innerText});s.push(n);B(e.getField(),"BX.Landing.UI.Field:change",function(t){n.innerHTML=g("div",{html:t}).innerText});return}if(e instanceof BX.Landing.Block.Node.Link){n=g("span",{props:{className:"landing-card-title-link"},html:e.getValue().text});s.push(n);B(e.getField(),"BX.Landing.UI.Field:change",function(t){n.innerHTML=t.text});return}if(e instanceof BX.Landing.Block.Node.Icon){n=g("span",{props:{className:"landing-card-title-icon"},children:[g("span",{props:{className:e.getValue().classList.join(" ")}})]});s.push(n);B(e.getField(),"BX.Landing.UI.Field:change",function(t){n.firstChild.className="landing-card-title-icon "+t.classList.join(" ")});return}if(e instanceof BX.Landing.Block.Node.Img){n=g("span",{props:{className:"landing-card-title-img"},attrs:{style:"background-color: #fafafa"},children:[g("img",{props:{src:e.getValue().src}})]});s.push(n);B(e.getField(),"BX.Landing.UI.Field:change",function(t){n.innerHTML="";n.appendChild(g("img",{props:{src:t.src}}))})}}},this);return g("div",{props:{className:"landing-card-title"},children:!c(s)?s:e.name})},initCards:function(){this.cards.clear();this.forEachCard(function(t,e,n){var i=this.manifest.cards[e];var s=X(e,"@",n);O(t);var a=new BX.Landing.Block.Card(t,i,s);this.cards.add(a);if(i.allowInlineEdit!==false){var o=new K("cardAction","landing-ui-panel-block-card-action");o.show();a.addPanel(o);o.addButton(new Q("clone",{html:"&nbsp;",onClick:function(t){t.stopPropagation();this.cloneCard(s)}.bind(this),attrs:{title:BX.message("LANDING_TITLE_OF_CARD_ACTION_CLONE")}}));o.addButton(new Q("remove",{html:"&nbsp;",onClick:function(t){t.stopPropagation();this.removeCard(s)}.bind(this),attrs:{title:BX.message("LANDING_TITLE_OF_CARD_ACTION_REMOVE")}}))}a.selector=s;this.adjustCardRemoveButton(s)});this.cards.sort(function(t,e){return t.getIndex()>e.getIndex()})},cloneCard:function(t,e){var i=this.cards.getBySelector(t);var s=i.panels.get("cardAction").buttons.get("clone");var a={block:this.id,selector:t,lid:this.lid,siteId:this.siteId};var o={code:this.manifest.code};var r=this;pt(s);return rt.action("Landing\\Block::cloneCard",a,o).then(function(){m("BX.Landing.Block:Card:beforeAdd",[r.createEvent({card:i.node})])}).then(function(){var t=BX.clone(i.node);O(t);n(t,i.node);return t}).then(function(t){mt(s);m("BX.Landing.Block:Card:add",[r.createEvent({card:t})]);r.initEntities();if(!e){var n=w(t.parentNode);var a=r.cards.getByNode(t);BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:r.id,selector:a.selector,command:"addCard",undo:{container:n,selector:a.selector},redo:{container:n,index:i.getIndex(),html:t.outerHTML}}))}}).catch(function(){mt(s);return Promise.reject()})},removeCard:function(t,e){var n=this.cards.getBySelector(t);var i=n.panels.get("cardAction").buttons.get("remove");var s={block:this.id,selector:t,lid:this.lid,siteId:this.siteId};var a={code:this.manifest.code};var o=this;pt(i);return rt.action("Landing\\Block::removeCard",s,a).then(function(){m("BX.Landing.Block:Card:beforeRemove",[o.createEvent({card:n.node})]);if(!e){var t=w(n.node.parentElement);BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:o.id,selector:n.selector,command:"removeCard",undo:{container:t,index:n.getIndex(),html:n.node.outerHTML},redo:{container:t,selector:n.selector}}))}}).then(function(){o.cards.remove(n);n.node.remove();o.initEntities();o.adjustCardRemoveButton(t)}).then(function(){var e=o.createEvent({data:{selector:t}});m("BX.Landing.Block:Card:remove",[e]);mt(i)}).catch(function(){mt(i);return Promise.reject()})},adjustCardRemoveButton:function(t){var e=this.cards.getBySelector(t);if(e){var n=e.node.parentElement.children.length===1;if(n){e.panels.get("cardAction").buttons.get("remove").disable()}else{e.panels.get("cardAction").buttons.get("remove").enable()}}},addCard:function(t){var e=t.selector.split("@")[0]+(t.index>0?"@"+(t.index-1):"");var i={block:this.id,content:t.content,selector:e,lid:this.lid,siteId:this.siteId};var s={code:this.manifest.code};var a=t.container;var o=g("div",{html:t.content}).firstElementChild;var r=this;return rt.action("Landing\\Block::addCard",i,s).then(function(){m("BX.Landing.Block:Card:beforeAdd",[r.createEvent({card:o})])}).then(function(){var i;if(t.index<=0){i=r.cards.find(function(t){return t.selector.includes(e.split("@")[0])});if(i){M(o,i.node.parentNode)}}else{i=r.cards.getBySelector(e.split("@")[0]+"@"+(t.index-1));if(i){n(o,i.node)}}O(a);r.initEntities();m("BX.Landing.Block:Card:add",[r.createEvent({card:o})])})},forEachCard:function(t){var e=Object.keys(this.manifest.cards);e.map(function(e){var n=T(this.node.querySelectorAll(e));n.forEach(function(n,i){t.apply(this,[n,e,i])},this)},this)},initNodes:function(){var t=[];this.forEachNodeElements(function(e,n,i){var s=this.nodes.getByNode(e);var o=X(n,"@",i);if(!s){var r=k(this.manifest.nodes[n].handler);var d=e.closest("[data-card-preset]");var c=P(this.manifest.nodes[n]);var h=false;if(d){var u=d.dataset.cardPreset;Object.keys(this.manifest.cards).forEach(function(t){if(d.matches(t)){if(a(this.manifest.cards[t].presets)&&a(this.manifest.cards[t].presets[u])&&l(this.manifest.cards[t].presets[u].disallow)){var e=this.manifest.cards[t].presets[u].disallow.find(function(t){return n===t});if(e){c.allowInlineEdit=false;h=true}}}},this)}s=new r({node:e,manifest:c,selector:o,onChange:this.onNodeChange.bind(this),onChangeOptions:this.onNodeOptionsChange.bind(this),onDesignShow:this.showStylePanel.bind(this),uploadParams:{action:"Block::uploadFile",block:this.id}});if(h){s.getField().layout.hidden=true}this.nodes.add(s)}s.selector=o;t.push(s)});this.nodes.clear();t.forEach(function(t){this.nodes.add(t)},this);this.nodes.sort(function(t,e){return t.getIndex()>e.getIndex()})},onNodeOptionsChange:function(t){if(!c(t)){var e={code:this.manifest.code};var n={};n.data=t;n.block=this.id;n.siteId=this.siteId;return BX.Landing.Backend.getInstance().action("Block::changeNodeName",n,e)}},forEachNodeElements:function(t){Object.keys(this.manifest.nodes).forEach(function(e){try{T(this.node.querySelectorAll(e)).forEach(function(n,i){if(!n.matches('[data-id="content_edit"] *')){t.apply(this,[n,e,i])}},this)}catch(t){}},this)},showContentPanel:function(t){var e=!!t&&t.nodes?t.nodes:this.nodes;var n=!!t&&t.name?t.name:null;var i=!!t&&t.nodesOnly?t.nodesOnly:false;var a=!!t&&t.compact;var o=this.panels.get("content_edit");if(!o){o=new z("content_edit",{title:BX.message("LANDING_CONTENT_PANEL_TITLE"),subTitle:this.manifest.block.name,footer:[new W("save_block_content",{text:BX.message("BLOCK_SAVE"),onClick:this.onContentSave.bind(this),className:"landing-ui-button-content-save",attrs:{title:BX.message("LANDING_TITLE_OF_SLIDER_SAVE")}}),new W("cancel_block_content",{text:BX.message("BLOCK_CANCEL"),onClick:this.onContentCancel.bind(this),className:"landing-ui-button-content-cancel",attrs:{title:BX.message("LANDING_TITLE_OF_SLIDER_CANCEL")}})]});this.addPanel(o)}o.compact(a);o.clear();var r=this.getBlockFromRepository(this.manifest.code);if(r&&r.restricted){s(this.getRestrictedMessage(),o.content)}this.getEditForms(e,n,i).forEach(o.appendForm,o);o.show()},getRestrictedMessage:function(){return g("div",{props:{className:"ui-alert ui-alert-warning"},html:BX.message("LANDING_BLOCK_RESTRICTED_TEXT"),attrs:{style:"margin-bottom: 20px"}})},onStyleShow:function(){this.showStylePanel(this.selector);BX.Landing.UI.Panel.EditorPanel.getInstance().hide()},getPostfix:function(){return""},expandTypeGroups:function(t){var e=[];if(!BX.type.isArray(t)){t=[t]}t.forEach(function(t){if(ft(t)){gt(t).forEach(function(t){e.push(t)})}else{e.push(t)}});return e},createStyleForm:function(t,e,n){var i=this.forms.get(t);if(!i){var s=!!e.props?e.props:!!e.type?e.type:null;var a=!!e.title?e.title:!!e.name?e.name:"";if(!!s&&!!a){var o=new Z({frame:window,postfix:this.getPostfix()});i=new tt({id:t,title:a,selector:t,iframe:window});s=this.expandTypeGroups(s);s.forEach(function(e){var s=ut(e);var a=this.styles.get(t);var r=o.createField({selector:!n?this.makeRelativeSelector(t):t,property:s.property,style:e,pseudoElement:s["pseudo-element"],pseudoClass:s["pseudo-class"],type:s.type,title:s.name,items:s.items,onChange:function(e,o,r,d){var l=!!s.exclude?ut(s.exclude):null;if(l){i.fields.forEach(function(t){if(t.style===s.exclude){t.reset()}})}var c={className:"",style:""};if(a.node[0]){c.className=a.node[0].className;c.style=a.node[0].style.cssText}var h=this.createEvent({data:{selector:t,value:e,items:o,postfix:r,affect:d,exclude:l}});m(window,"BX.Landing.Block:beforeApplyStyleChanges",[h]);a.setValue(e,o,r,d,l);var u={className:"",style:""};if(a.node[0]){u.className=a.node[0].className;u.style=a.node[0].style.cssText}try{if(JSON.stringify(c)!==JSON.stringify(u)){BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:this.id,command:"updateStyle",selector:!n?this.makeRelativeSelector(t):t,undo:c,redo:u}))}}catch(t){}this.onStyleInputWithDebounce({node:a.getNode(),data:a.getValue()})}.bind(this)});var d=true;a.getValue().classList.forEach(function(t){if(s.items.some(function(e){return e.value===t})){r.setValue(t,d)}});i.addField(r)},this);this.forms.add(i)}}i.fields.forEach(function(t){if(t.popup){t.popup.close()}});return i},initStyles:function(){this.styles.clear();var t=new BX.Landing.UI.Style({id:this.selector,iframe:window,selector:this.selector,relativeSelector:this.selector,onClick:this.onStyleClick.bind(this,this.selector)});this.styles.add(t);if(a(this.manifest.style.nodes)){Object.keys(this.manifest.style.nodes).forEach(function(t){var e=new BX.Landing.UI.Style({id:t,iframe:window,selector:t,relativeSelector:this.makeRelativeSelector(t),onClick:this.onStyleClick.bind(this,t)});this.styles.add(e)},this)}},onStyleClick:function(t){this.showStylePanel(t);var e=this.forms.get(t);if(e){BX.Landing.PageObject.getInstance().design().then(function(t){BX.Landing.UI.Panel.Content.scrollTo(t.content,null)})}},makeRelativeSelector:function(t){return X(this.selector," ",t)},makeAbsoluteSelector:function(t){t=t||this.selector;t=U(t);var e=t===this.selector?" > :first-child":this.selector;return U(t.replace(e,""))},saveStyles:function(){var t=this.styles.fetchChanges();if(t.length){t.forEach(function(t){if(t.selector===this.selector){t.selector=t.selector.replace(" > :first-child","")}if(!t.isSelectGroup()&&t.selector!==this.makeAbsoluteSelector(this.selector)){t.selector=X(t.selector.split("@")[0],"@",t.getElementIndex(t.getNode()[0]))}},this);var e=t.fetchValues();rt.action("Landing\\Block::updateStyles",{block:this.id,data:e,lid:this.lid,siteId:this.siteId},{code:this.manifest.code})}},showStylePanel:function(t){BX.Landing.PageObject.getInstance().design().then(function(t){t.clearContent();return t.show()}).then(function(e){var n=this.isBlockSelector(t);var i=this.getStyleOptions(t);if(l(i.type)||d(i.type)){if(i.type.length){e.appendForm(this.createStyleForm(t,i,n))}}if(a(i.additional)){t=i.selector?i.selector:t;e.appendForm(this.createAdditionalForm({form:tt,selector:t,group:i.additional,onChange:this.onAttributeChange.bind(this)}));return}if(l(i.additional)){i.additional.forEach(function(n){e.appendForm(this.createAdditionalForm({form:tt,selector:t,group:n,onChange:this.onAttributeChange.bind(this)}))},this)}}.bind(this))},getStyleOptions:function(t){if(this.isBlockSelector(t)){return this.prepareBlockOptions(this.manifest.style.block)}return this.manifest.style.nodes[t]},createAdditionalForm:function(t){var e=new t.form({title:t.group.name,type:"attrs"});t.group.attrs.forEach(function(n){var i=n.selector||t.selector;var s;if(l(n.tabs)){var a=new at({tabs:n.tabs.map(function(e){return{id:D(),name:e.name,active:e.active,fields:e.attrs.map(function(e){return this.createAttributeField(e,e.selector||t.selector,t.onChange)},this)}},this)});e.addCard(a);return}s=this.createAttributeField(n,i,t.onChange);e.addField(s)},this);return e},prepareBlockOptions:function(t){t=a(t)?t:{};t=P(t);t.name=BX.message("BLOCK_STYLE_OPTIONS");if(!a(t.type)&&!d(t.type)&&!l(t.type)){t.type=["display","padding-top","padding-bottom","padding-left","padding-right","margin-top","background-color","background-gradient"]}return t},createAttributeField:function(t,e,n){var i=this.createFieldFactory(e,n);var s=this.getElementBySelector(e);if(!s&&e.includes("@")){var a=e.split("@");var o=this.getElementsBySelector(a[0]);if(o.length&&o[parseInt(a[1])]){s=o[parseInt(a[1])]}}var r=P(t);if(r.value===null||r.value===undefined){r.value=""}if(s){var d=A(s,r.attribute);if(d!==null){r.value=d}}return i.create(r)},onAttributeChange:function(t){clearTimeout(this.attributeChangeTimeout);if(!this.requestData){this.requestData={}}this.appendAttrFieldValue(this.requestData,t);if(this.containsPseudoSelector(this.requestData)&&!this.attributeChangeLoader){this.attributeChangeLoader=new BX.Loader({target:this.node,color:"rgba(255, 255, 255, .8)"});this.attributeChangeLoader.layout.style.position="fixed";this.attributeChangeLoader.layout.style.zIndex="999";this.attributeChangeLoader.show();BX.Landing.Main.getInstance().showOverlay()}this.attributeChangeTimeout=setTimeout(function(){Promise.resolve(this.requestData).then(this.applyAttributeChanges.bind(this)).then(this.saveChanges.bind(this)).then(this.reload.bind(this)).then(function(){this.requestData=null;this.attributeChangeLoader=null;BX.Landing.Main.getInstance().hideOverlay()}.bind(this))}.bind(this),800)},appendAttrFieldValue:function(t,e){var n=this.makeAbsoluteSelector(e.selector);var i=e.getValue();try{i=N(i)}catch(t){i=e.getValue()}t[n]=t[n]||{};t[n]["attrs"]=t[n]["attrs"]||{};t[n]["attrs"][e.attribute]=i;return t},getElementBySelector:function(t){if(this.isBlockSelector(t)){return this.content}var e;try{e=this.node.querySelector(t)}catch(t){e=null}return e},getElementsBySelector:function(t){if(this.isBlockSelector(t)){return[this.content]}var e;try{e=T(this.node.querySelectorAll(t))}catch(t){e=[]}return e},isBlockSelector:function(t){return!t||t===this.selector||"#block"+this.id===t},createFieldFactory:function(t,e){return new BX.Landing.UI.Factory.FieldFactory({selector:!this.isBlockSelector(t)?this.makeRelativeSelector(t):t,uploadParams:{action:"Block::uploadFile",block:this.id,lid:BX.Landing.Main.getInstance().id,id:BX.Landing.Main.getInstance().options.site_id},linkOptions:{siteId:BX.Landing.Main.getInstance().options.site_id,landingId:BX.Landing.Main.getInstance().id,filter:{"=TYPE":BX.Landing.Main.getInstance().options.params.type}},onValueChange:e||function(){}})},deleteBlock:function(t){var n=this.panels.get("block_action").buttons.get("remove");n.loader=n.loader||new BX.Loader({target:n.layout,size:28});n.loader.show();h(n.text,"landing-ui-hide-icon");void e(n.loader.layout.querySelector(".main-ui-loader-svg-circle"),{"stroke-width":"4px"});BX.Landing.UI.Panel.EditorPanel.getInstance().hide();if(this.blockActionsMenu){BX.PopupMenu.destroy(this.blockActionsMenu.id)}window.localStorage.removeItem("landingBlockId");rt.action("Landing::markDeletedBlock",{block:this.id,lid:this.lid,siteId:this.siteId},{code:this.manifest.code}).then(function(){n.loader.hide();u(n.text,"landing-ui-hide-icon");var e=this.createEvent();m("BX.Landing.Block:remove",[e]);T(this.node.querySelectorAll(".landing-ui-panel")).forEach(S);if(o(t)&&!t||!o(t)){var i=top.BX.Landing.Block.storage.getByNode(BX.findPreviousSibling(this.node,{className:"block-wrapper"}));BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:this.id,selector:"#block"+this.id,command:"removeBlock",undo:{currentBlock:i?i.id:null,lid:this.lid,code:this.manifest.code},redo:""}))}top.BX.Landing.Block.storage.remove(this);S(this.node);m("Landing.Block:onAfterDelete",[this]);m("BX.Landing.Block:afterRemove",[e])}.bind(this),function(){n.loader.hide();u(n.text,"landing-ui-hide-icon")})},addBlockAfterThis:function(){BX.Landing.Main.getInstance().showBlocksPanel(this)},onNodeChange:function(t){var e=this.createEvent({node:t.node});m("BX.Landing.Block:Node:update",[e]);if(!t.isSavePrevented()){clearTimeout(this.changeTimeout);this.changedNodes.add(t);this.changeTimeout=setTimeout(function(){rt.action("Landing\\Block::updateNodes",{block:this.id,data:this.changedNodes.fetchValues(),lid:this.lid,siteId:this.siteId},{code:this.manifest.code});this.changedNodes.clear()}.bind(this),100)}},containsPseudoSelector:function(t){return Object.keys(t).some(function(t){var e;if(t==="cards"){return false}try{if(t!=="#block"+this.id&&t!==""){e=!this.node.querySelector(t)}else{e=false}}catch(n){e=!Bt(t)}return e},this)},applyContentChanges:function(t){if(!a(t)){return Promise.reject(new TypeError("BX.Landing.Block.applyContentChanges: data isn't object"))}var e=P(t);Object.keys(e).forEach(function(t){if(!Bt(t)){delete e[t]}});if(!c(e)){var n=this.createEvent({data:e});m(window,"BX.Landing.Block:beforeApplyContentChanges",[n])}Object.keys(t).forEach(function(e){if(Bt(e)){var n=this.nodes.getBySelector(e);if(n){n.setValue(t[e],true);t[e]=n.getValue()}}},this);return Promise.resolve(t)},applyCardsChanges:function(t){if(!a(t)){return Promise.reject(new TypeError("BX.Landing.Block.applyCardsChanges: data isn't object"))}if("cards"in t&&a(t.cards)){m("BX.Landing.Block:Cards:beforeUpdate",[this.createEvent()]);Object.keys(t.cards).forEach(function(e){var n=this.node.querySelector(e).parentElement;var i=this.node.querySelectorAll(e);var a=t.cards[e].values;var o=t.cards[e].presets;var r=t.cards[e].indexes;var d=t.cards[e].source;n.innerHTML="";Object.keys(a).forEach(function(t){d[t]={value:0,type:"card"};if(!c(o)&&!c(o[t])&&!i[r[t]]){d[t].type="preset";d[t].value=o[t];return}if(i[r[t]]){d[t].type="card";d[t].value=r[t]}},this);Object.keys(a).forEach(function(t){if(d[t].type==="preset"){var a=this.manifest.cards[e]["presets"][d[t].value]["html"];s(F(a),n);return}s(P(i[d[t].value]),n)},this);this.initNodes();this.initCards();this.initGroups();var l={};Object.keys(a).forEach(function(t){var e=a[t];Object.keys(e).forEach(function(t){l[t]=t in l?l[t]+1:0;var n=this.nodes.getBySelector(X(t,"@",l[t]));if(n){n.setValue(e[t],true,true)}},this)},this);this.initCardsLabels();this.initStyles();delete t.cards[e].presets;delete t.cards[e].indexes},this);m("BX.Landing.Block:Cards:update",[this.createEvent()])}return Promise.resolve(t)},applyAttributeChanges:function(t){if(!a(t)){return Promise.reject(new TypeError("BX.Landing.Block.applyAttributeChanges: requestData isn't object"))}var e=P(t);Object.keys(t).forEach(function(n){if(!(a(t[n])&&"attrs"in t[n])){delete e[n]}});if(!c(e)){var n=this.createEvent({data:e});m(window,"BX.Landing.Block:beforeApplyAttributesChanges",[n])}var i=this;Object.keys(t).forEach(function(e){if(a(t[e])&&"attrs"in t[e]){var n=i.getElementsBySelector(e);if(!n.length&&e.includes("@")){var s=e.split("@");n=i.getElementsBySelector(s[0]);if(n[parseInt(s[1])]){n=[n[parseInt(s[1])]]}}Object.keys(t[e].attrs).forEach(function(s){n.forEach(function(n){var a=_(t[e]["attrs"][s]);A(n,s,a);m("BX.Landing.Block:Node:updateAttr",[i.createEvent({node:n,data:t[e]["attrs"]})])})})}});return Promise.resolve(t)},saveChanges:function(t){if(!a(t)){return Promise.reject(new TypeError("BX.Landing.Block.saveChanges: data isn't object"))}if(Object.keys(t).length){var e={code:this.manifest.code};var n={block:this.id,data:t,lid:this.lid,siteId:this.siteId};if(!c(t.cards)){var i=P(t.cards);delete t.cards;var s={};s.updateCards={action:"Block::updateCards",data:{block:this.id,lid:this.lid,siteId:this.siteId,data:i}};if(!c(t)){s.updateNodes={action:"Block::updateNodes",data:n}}return rt.batch("Landing\\Block::updateNodes",s).then(function(){return Promise.resolve(t)})}else{return rt.action("Landing\\Block::updateNodes",n,e).then(function(){return Promise.resolve(t)})}}else{return Promise.resolve(t)}},fetchRequestData:function(t){var e={};var n={};n.attrs=new G;n.cards=new G;n.content=new G;t.forms.forEach(function(t){n[t.type].push(t)});n.content.fetchFields().fetchChanges().reduce(x(this.appendContentFieldValue,this),e);var i=new j;n.cards.forEach(function(t){t.childForms.forEach(function(t){t.fields.forEach(function(t){if(t.type==="attr"){i.add(t)}})})});i.fetchChanges().reduce(x(this.appendAttrFieldValue,this),e);n.cards.fetchChanges().reduce(x(this.appendCardsFormValue,this),e);n.attrs.fetchFields().fetchChanges().reduce(x(this.appendAttrFieldValue,this),e);return Promise.resolve(e)},appendContentFieldValue:function(t,e){return t[e.selector]=e.getValue(),t},appendCardsFormValue:function(t,e){t.cards=t.cards||{};t.cards[e.code]={};t.cards[e.code]["values"]=e.serialize();t.cards[e.code]["presets"]=e.getUsedPresets();t.cards[e.code]["indexes"]=e.getIndexesMap();t.cards[e.code]["source"]={};return t},reload:function(t){if(!this.containsPseudoSelector(t)){return Promise.resolve(t)}var e=this;return BX.Landing.Backend.getInstance().action("Block::getContent",{block:this.id,lid:this.lid,siteId:this.siteId,editMode:1}).then(function(t){BX.Landing.Main.getInstance().currentBlock=e;BX.Landing.Main.getInstance().currentArea=e.parent;return BX.Landing.Main.getInstance().addBlock(t,true,true)}).then(function(n){e.node=n;return Promise.resolve(t)})},onContentSave:function(){var t=this.panels.get("content_edit");if(t){t.hide();this.fetchRequestData(t).then(this.applyContentChanges.bind(this)).then(this.applyCardsChanges.bind(this)).then(this.applyAttributeChanges.bind(this)).then(this.saveChanges.bind(this)).then(this.reload.bind(this)).catch(console.warn);var e=new G;t.forms.forEach(function(t){if(t.type!=="attrs"){e.add(t)}});var n={};e.fetchFields().forEach(function(t){if(t.tag){n[t.selector]={tagName:t.tag}}},this);this.onNodeOptionsChange(n)}},onContentCancel:function(){this.panels.get("content_edit").hide()},getCardsSelector:function(){var t=Object.keys(this.manifest.cards);var e=X(t.join(","),", ");var n=X(t.join(" *,")," *");return X(e,n)},onStyleInput:function(t){this.saveStyles();var e=this.createEvent(t);m("BX.Landing.Block:updateStyle",[e])},getEditForms:function(t,e,n){var i=new G;var s=Object.keys(this.manifest.nodes);var o=new R;var r=t;if(this.cards.length){r=t.notMatches(this.getCardsSelector())}s.forEach(function(t){r.matches(t).forEach(function(t){o.push(t)})},this);if(o.length){var c=new $({title:e||BX.message("BLOCK_HEADER"),type:"content"});o.forEach(function(t){c.addField(t.getField())});i.add(c)}var h=Object.keys(this.manifest.attrs);if(h.length&&!n){var u=new $({id:"attr",type:"attrs",title:BX.message("BLOCK_SETTINGS")});i.add(u);h.forEach(function(t){var e=this.manifest.attrs[t];if(!e.hidden){e=!l(e)?[e]:e;e.forEach(function(e){if(e.hidden){return}if(d(e.type)){u.addField(this.createAttributeField(e,t));return}if(d(e.name)&&e.attrs){i.add(this.createAdditionalForm({form:$,selector:t,group:e,onChange:function(){}}))}},this)}},this);if(u.fields.length===0){i.remove(u)}}var f=Object.keys(this.manifest.cards);f.forEach(function(e){var n=this.cards.filter(function(t){return t.selector.split("@")[0]===e});if(n.length){var o=this.manifest.cards[e]["group_label"];var r=new nt({title:o||BX.message("LANDING_CARDS_FROM_TITLE"),code:e.split("@")[0],presets:n[0].manifest.presets});n.forEach(function(n){var i=new et({label:n.getLabel()||n.getName(),labelBindings:n.manifest.label,selector:n.selector,preset:n.preset});var o=new R;var d=t.filter(function(t){return n.node.contains(t.node)});if(d.length){s.forEach(function(t){var e=d.matches(t);e.forEach(o.add,o)},this);o.forEach(function(t){i.addField(t.getField())});var c=this.manifest.cards[e].additional;if(a(c)){if(l(c.attrs)){c.attrs.forEach(function(t){var e=this.createAttributeField(t,n.selector,function(){});e.type="attr";i.addField(e)},this)}}r.addChildForm(i)}},this);if(r.childForms.length){i.add(r)}}},this);return i},isLastBlockInArea:function(){return this.parent.querySelectorAll(".block-wrapper").length<2},onBlockRemove:function(){this.adjustSortButtonsState()},onBlockInit:function(){this.adjustSortButtonsState()},adjustSortButtonsState:function(){var t=this.panels.get("block_action");if(t){if(this.isLastBlockInArea()){t.buttons.get("up").disable();t.buttons.get("down").disable()}else{t.buttons.get("up").enable();t.buttons.get("down").enable()}}}}})();