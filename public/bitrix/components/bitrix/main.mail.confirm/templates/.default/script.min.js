(function(){if(window.BXMainMailConfirm)return;var e={showForm:function(e){var t="email";var a=new BX.PopupWindow("add_from_email",null,{width:480,titleBar:BX.message("MAIN_MAIL_CONFIRM_TITLE"),draggable:true,closeIcon:true,lightShadow:true,contentColor:"white",contentNoPaddings:true,content:BX("new_from_email_dialog_content").innerHTML,buttons:[new BX.PopupWindowButton({text:BX.message("MAIN_MAIL_CONFIRM_GET_CODE"),className:"popup-window-button-create",events:{click:function(){var i=this;if(BX.hasClass(i.buttonNode,"popup-window-button-wait"))return;var n=BX.findChildByClassName(a.contentContainer,"new-from-email-dialog-email-block",true);var o=BX.findChildByClassName(a.contentContainer,"new-from-email-dialog-code-block",true);var l=BX.findChild(n,{attr:{"data-name":"name"}},true);var r=BX.findChild(n,{attr:{"data-name":"email"}},true);var s=BX.findChild(o,{attr:{"data-name":"code"}},true);var u=BX.findChild(a.contentContainer,{attr:{"data-name":"public"}},true);var d=BX.findChild(n,{attr:{"data-name":"smtp-server"}},true);var m=BX.findChild(n,{attr:{"data-name":"smtp-port"}},true);var f=BX.findChild(n,{attr:{"data-name":"smtp-login"}},true);var _=BX.findChild(n,{attr:{"data-name":"smtp-password"}},true);if("email"==t||"smtp"==t){s.value="";var M="[=a-z0-9_+~'!$&*^`|#%/?{}-]";var h=new RegExp("^"+M+"+(\\."+M+"+)*@([a-z0-9-]+\\.)+[a-z0-9-]{2,20}$","i");if(!r.value.match(h)){a.showNotify(BX.message(r.value.length>0?"MAIN_MAIL_CONFIRM_INVALID_EMAIL":"MAIN_MAIL_CONFIRM_EMPTY_EMAIL"));return}}if("smtp"==t){if(!d.value.match(/^([a-z0-9-]+\.)+[a-z0-9-]{2,20}$/)){a.showNotify(BX.message(d.value.length>0?"MAIN_MAIL_CONFIRM_INVALID_SMTP_SERVER":"MAIN_MAIL_CONFIRM_EMPTY_SMTP_SERVER"));return}if(!m.value.match(/^[0-9]+$/)||m.value<1||m.value>65535){a.showNotify(BX.message(m.value.length>0?"MAIN_MAIL_CONFIRM_INVALID_SMTP_PORT":"MAIN_MAIL_CONFIRM_EMPTY_SMTP_PORT"));return}if(!(f.value.length>0)){a.showNotify(BX.message("MAIN_MAIL_CONFIRM_EMPTY_SMTP_LOGIN"));return}if(!(_.value.length>0)){a.showNotify(BX.message("MAIN_MAIL_CONFIRM_EMPTY_SMTP_PASSWORD"));return}}if("code"==t){if(s.value.length==0){a.showNotify(BX.message("MAIN_MAIL_CONFIRM_EMPTY_CODE"));return}}a.hideNotify();BX.addClass(i.buttonNode,"popup-window-button-wait");var N={name:l.value,email:r.value,smtp:{},code:"",public:u.checked?u.value:""};if("smtp"==t){N.smtp={server:d.value,port:m.value,login:f.value,password:_.value}}if("code"==t){N.code=s.value}BX.ajax({url:"/bitrix/components/bitrix/main.mail.confirm/ajax.php?act=add",method:"POST",dataType:"json",data:N,onsuccess:function(s){BX.removeClass(i.buttonNode,"popup-window-button-wait");if(s.result=="error"){a.showNotify(s.error)}else if(t=="email"){t="code";n.style.height=n.offsetHeight+"px";n.offsetHeight;n.style.height="0px";o.style.position="absolute";o.style.display="";var u=o.offsetHeight;o.style.height="0px";o.style.position="";o.offsetHeight;o.style.height=u+"px";i.setName(BX.message("MAIN_MAIL_CONFIRM_SAVE"))}else{i.popupWindow.close();if(BX.type.isFunction(e)){var d=l.value.length>0?l.value:BX.message("MAIN_MAIL_CONFIRM_USER_FULL_NAME");e({name:d,email:r.value},d.length>0?d+" <"+r.value+">":r.value)}}},onfailure:function(e){BX.removeClass(i.buttonNode,"popup-window-button-wait");a.showNotify(BX.message("MAIN_MAIL_CONFIRM_AJAX_ERROR"))}})}}}),new BX.PopupWindowButton({text:BX.message("MAIN_MAIL_CONFIRM_CANCEL"),className:"popup-window-button-link",events:{click:function(){this.popupWindow.close()}}})]});a.hideNotify=function(){var e=BX.findChild(a.contentContainer,{class:"new-from-email-dialog-error"},true);BX.hide(e,"block")};a.showNotify=function(e){var t=BX.findChild(a.contentContainer,{class:"new-from-email-dialog-error"},true);t.innerHTML=e;BX.show(t,"block")};var i=BX.findChildByClassName(a.contentContainer,"new-from-email-dialog-smtp-link",true);var n=BX.findChildByClassName(a.contentContainer,"new-from-email-dialog-smtp-block",true);if(i&&n){BX.bind(i,"click",function(e){if("smtp"==t){t="email";BX.hide(n,"table-row-group");a.buttons[0].setName(BX.message("MAIN_MAIL_CONFIRM_GET_CODE"))}else{t="smtp";BX.show(n,"table-row-group");a.buttons[0].setName(BX.message("MAIN_MAIL_CONFIRM_SAVE"))}e.preventDefault()})}a.show();var o=BX.findChildByClassName(a.contentContainer,"new-from-email-dialog-email-block",true);var l=BX.findChild(o,{attr:{"data-name":"name"}},true);var r=BX.findChild(o,{attr:{"data-name":"email"}},true);if(l.value.length>0){r.focus()}else{l.focus()}}};window.BXMainMailConfirm=e})();